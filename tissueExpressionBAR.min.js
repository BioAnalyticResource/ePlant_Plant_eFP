class RetrieveOnlineBARData{constructor(){this.eFPObjects={};this.sampleData={}};loadSampleData(svgName,locus,continueForward=!0){if(this.sampleData.AbioticStress===undefined){let xhr=new XMLHttpRequest();let url='https://raw.githubusercontent.com/BioAnalyticResource/ePlant_Plant_eFP/master/data/SampleData.json';xhr.responseType='json';xhr.onreadystatechange=()=>{if(xhr.readyState===XMLHttpRequest.DONE&&xhr.status===200){this.sampleData=xhr.response;this.retrieveSampleData(svgName,locus)}};xhr.open('GET',url);xhr.send()};if(this.sampleData.AbioticStress&&continueForward){this.retrieveSampleData(svgName,locus)}};retrieveSampleData(svgName,locus){if(svgName.substr(-4)==='.svg'){svgName=svgName.substr(0,svgName.length-4)};var sampleDataKeys=Object.keys(this.sampleData);var sampleDB='';var sampleIDList=[];var sampleSubunits=[];if(sampleDataKeys.includes(svgName)){let DataKeyPos=sampleDataKeys.indexOf(svgName);var sampleInfo=this.sampleData[sampleDataKeys[DataKeyPos]];var sampleOptions=sampleInfo.sample;sampleDB=sampleInfo.db;if(sampleDB!=undefined){sampleSubunits=Object.keys(sampleInfo.sample);sampleIDList=[];for(var sK=0;sK<sampleSubunits.length;sK++){sampleIDList=sampleIDList.concat(sampleOptions[sampleSubunits[sK]])}};this.callPlantEFP(sampleDB,locus,sampleIDList,svgName,sampleOptions)}};callPlantEFP(datasource,locus,samples,svg,sampleSubunits){let xhr=new XMLHttpRequest();let url='https://bar.utoronto.ca/~asullivan/webservices/plantefp.cgi?';url+='datasource='+datasource+'&';url+='id='+locus+'&';url+='samples=[';for(var i=0;i<samples.length;i++){url+='"'+samples[i]+'"';if(i!=samples.length-1){url+=','}};url+=']';xhr.responseType='json';xhr.onreadystatechange=()=>{if(xhr.readyState===XMLHttpRequest.DONE&&xhr.status===200){let subunitsList=Object.keys(sampleSubunits);var response=xhr.response;if(this.eFPObjects===undefined){this.eFPObjects={}}
if(this.eFPObjects[svg]===undefined){this.eFPObjects[svg]={}};if(this.eFPObjects[svg].sample===undefined){this.eFPObjects[svg].sample={}};if(this.eFPObjects[svg].sample===undefined){this.eFPObjects[svg].sample={}};for(var t=0;t<response.length;t++){var responseName=response[t].name.trim();var responseValue=response[t].value;var subunitName='';var tempName=responseName;tempName=responseName.replace(/\+/g,'%2B');tempName=tempName.replace(/ /g,'+');tempName=tempName.trim();for(var s=0;s<subunitsList.length;s++){if(sampleSubunits[subunitsList[s]].includes(tempName)){subunitName=subunitsList[s];if(this.eFPObjects[svg].sample[subunitName]===undefined){this.eFPObjects[svg].sample[subunitName]={}};if(this.eFPObjects[svg].sample[subunitName][tempName]===undefined){this.eFPObjects[svg].sample[subunitName][tempName]={}};this.eFPObjects[svg].sample[subunitName][tempName][locus]=responseValue}}};this.eFPObjects[svg].db=datasource}};xhr.open('GET',url);xhr.send()}};class InteractiveSVGData{constructor(){this.topExpressionValues={}};retrieveTopExpressionValues(locus='AT3G24650'){if(this.expressionValues===undefined){let xhr=new XMLHttpRequest();let url='https://raw.githubusercontent.com/BioAnalyticResource/ePlant_Plant_eFP/master/data/topExpressionValues.json';xhr.responseType='json';xhr.onreadystatechange=()=>{if(xhr.readyState===XMLHttpRequest.DONE){let expressionResponse=xhr.response;this.expressionValues=expressionResponse;if(expressionResponse.locus[locus]!=undefined){this.topExpressionValues=expressionResponse.locus[locus]}else{this.topExpressionValues.error='No data for '+locus}}};xhr.open('GET',url);xhr.send()}else{let expressionResponse=this.expressionValues;if(expressionResponse.locus[locus]!=undefined){this.topExpressionValues=expressionResponse.locus[locus]}else{this.topExpressionValues.error='No data for '+locus}}}};let existingStrokeWidths={};let existingStrokeColours={};let expressionValues=undefined;function addTissueMetadata(elementID){if(elementID.includes('Half_Leaf_Pseudomonas_syringae')){elementID=elementID+'_outline'};var svgDoc=document.getElementById(createSVGExpressionData.svgObjectName).getSVGDocument();var svgPart=svgDoc.getElementById(elementID);var svgPartChildren=svgPart.childNodes;var increaseStrokeWidthBy=4;var svgDetailsAdded=!1;if(svgPartChildren.length>0){for(var s=0;s<svgPartChildren.length;s++){if(svgPartChildren[s].nodeName==='path'){var existingStrokeWidth=svgPartChildren[s].getAttribute('stroke-width');if(existingStrokeWidth===null||existingStrokeWidth===undefined){existingStrokeWidth=0};var existingStrokeColour=svgPartChildren[s].getAttribute('stroke');if(existingStrokeColour===null||existingStrokeColour===undefined){existingStrokeColour='none'};if(existingStrokeWidths[elementID]===undefined){existingStrokeWidths[elementID]=existingStrokeWidth;existingStrokeColours[elementID]=existingStrokeColour}else{existingStrokeWidth=existingStrokeWidths[elementID];existingStrokeColour=existingStrokeColours[elementID]};if((existingStrokeWidth*increaseStrokeWidthBy)<10&&(existingStrokeWidth*increaseStrokeWidthBy)!=0){svgPartChildren[s].setAttribute('stroke-width',(existingStrokeWidth*increaseStrokeWidthBy));svgPartChildren[s].setAttribute('stroke','#000000')}else{svgPartChildren[s].setAttribute('stroke-width',(increaseStrokeWidthBy*1.5));svgPartChildren[s].setAttribute('stroke','#000000')};svgDetailsAdded=!0}}};if(svgDetailsAdded===!1||svgPartChildren.length<=0||svgPartChildren===null){var existingStrokeWidth=svgPart.getAttribute('stroke-width');if(existingStrokeWidth===null||existingStrokeWidth===undefined){existingStrokeWidth=0};var existingStrokeColour=svgPart.getAttribute('stroke');if(existingStrokeColour===null||existingStrokeColour===undefined){existingStrokeColour='none'};if(existingStrokeWidths[elementID]===undefined){existingStrokeWidths[elementID]=existingStrokeWidth;existingStrokeColours[elementID]=existingStrokeColour}else{existingStrokeWidth=existingStrokeWidths[elementID];existingStrokeColour=existingStrokeColours[elementID]};if((existingStrokeWidth*increaseStrokeWidthBy)<10&&(existingStrokeWidth*increaseStrokeWidthBy)!=0){svgPart.setAttribute('stroke-width',(existingStrokeWidth*increaseStrokeWidthBy));svgPart.setAttribute('stroke','#000000')}else{svgPart.setAttribute('stroke-width',(increaseStrokeWidthBy*1.5));svgPart.setAttribute('stroke','#000000')};svgDetailsAdded=!0}};function removeTissueMetadata(elementID){if(elementID.includes('Half_Leaf_Pseudomonas_syringae')){elementID=elementID+'_outline'};var svgDoc=document.getElementById(createSVGExpressionData.svgObjectName).getSVGDocument();var svgPart=svgDoc.getElementById(elementID);var svgPartChildren=svgPart.childNodes;var svgDetailsRemoved=!1;if(svgPartChildren.length>0){for(var s=0;s<svgPartChildren.length;s++){if(svgPartChildren[s].nodeName==='path'){if(parseFloat(existingStrokeWidths[elementID])>=0){svgPartChildren[s].setAttribute('stroke-width',(existingStrokeWidths[elementID]));svgPartChildren[s].setAttribute('stroke',(existingStrokeColours[elementID]))}else{svgPartChildren[s].setAttribute('stroke-width',1.5);svgPartChildren[s].setAttribute('stroke','#000000')};svgDetailsRemoved=!0}}};if(svgDetailsRemoved===!1||svgPartChildren.length<=0||svgPartChildren===null){if(parseFloat(existingStrokeWidths[elementID])>=0){svgPart.setAttribute('stroke-width',(existingStrokeWidths[elementID]));svgPart.setAttribute('stroke',(existingStrokeColours[elementID]))}else{svgPart.setAttribute('stroke-width',1.5);svgPart.setAttribute('stroke','#000000')};svgDetailsRemoved=!0}};class CreateSVGExpressionData{constructor(){this.retrieveOnlineBARData=new RetrieveOnlineBARData();this.interactiveSVGData=new InteractiveSVGData();this.desiredDOMid;this.clickList=[];this.svgValues={};this.svgMax;this.svgMin;this.svgMaxAverage;this.svgMaxAverageSample;this.svgMinAverage;this.svgMinAverageSample;this.svgObjectName;this.finishedColouring=!1};addSVGtoDOM(svgName,locus){var urlSVG='https://bar.utoronto.ca/~asullivan/ePlant_Plant_eFP/compendiums/'+svgName+'.min.svg';var targetDOMRegion=document.getElementById(this.desiredDOMid);targetDOMRegion.innerHTML='';var appendSVG='<object id="'+svgName+'_object" data="'+urlSVG+'" type="image/svg+xml"></object>';targetDOMRegion.innerHTML=appendSVG;this.svgObjectName=svgName+'_object';var svgLoaded=!1;while(svgLoaded===!1){if(targetDOMRegion.innerHTML!=''){svgLoaded=!0;let svgObject=document.getElementById(svgName+'_object');svgObject.style='width: 100%; height: 100%; left: 0px; top: 0px; display: inline-block;';let timer=setTimeout(()=>{this.createLocusMatch(svgName,locus)},200)}}};createLocusMatch(whichSVG,locus){var locusPoint=locus;var locusValue='';for(var i=0;i<locusPoint.length;i++){if(i===1||i===3){locusValue=locusValue+locusPoint[i].toLowerCase()}else{locusValue=locusValue+locusPoint[i]}};this.createSVGValues(whichSVG,locus)};createSVGValues(whichSVG,locus){let svgSamples=[];let dataObject=this.retrieveOnlineBARData.eFPObjects;let svgDataObject=dataObject[whichSVG].sample;let svgSubunits=Object.keys(svgDataObject);for(var i=0;i<svgSubunits.length;i++){svgSamples.push(svgDataObject[svgSubunits[i]])};for(var n=0;n<svgSubunits.length;n++){var sampleValues=Object.keys(svgDataObject[svgSubunits[n]]);if(this.svgValues[svgSubunits[n]]===undefined){this.svgValues[svgSubunits[n]]={}};for(var v=0;v<sampleValues.length;v++){if(this.svgValues[svgSubunits[n]].rawValues===undefined){this.svgValues[svgSubunits[n]].rawValues=[]};this.svgValues[svgSubunits[n]].rawValues.push(svgDataObject[svgSubunits[n]][sampleValues[v]][locus])}};this.findMaxAndMin(whichSVG,svgSubunits)};findMaxAndMin(whichSVG,svgSubunits){this.svgMax=undefined;this.svgMin=undefined;for(var i=0;i<svgSubunits.length;i++){var values=this.svgValues[svgSubunits[i]].rawValues.sort();var numValues=[];for(var y=0;y<values.length;y++){if(isNaN(values[y])===!1){numValues.push(parseFloat(values[y]))}};var sumValues=0;for(var v=0;v<numValues.length;v++){sumValues+=numValues[v]};var averageValues=(sumValues/numValues.length);var maxValue=numValues[numValues.length-1];var minValue=numValues[1];if(this.svgMax===undefined){this.svgMax=maxValue}else{if(maxValue>this.svgMax){this.svgMax=maxValue}};if(this.svgMin===undefined){this.svgMin=minValue}else{if(minValue<this.svgMin){this.svgMin=minValue}};if(this.svgMaxAverage===undefined){this.svgMaxAverage=averageValues;this.svgMaxAverageSample=svgSubunits[i]}else{if(averageValues>this.svgMaxAverage){this.svgMaxAverage=averageValues;this.svgMaxAverageSample=svgSubunits[i]}};if(this.svgMinAverage===undefined){this.svgMinAverage=averageValues;this.svgMinAverageSample=svgSubunits[i]}else{if(averageValues<this.svgMinAverage){this.svgMinAverage=averageValues;this.svgMinAverageSample=svgSubunits[i]}};if(this.svgValues[svgSubunits[i]]===undefined){this.svgValues[svgSubunits[i]]={}};this.svgValues[svgSubunits[i]].average=averageValues};this.colourSVGs(whichSVG,svgSubunits)};colourSVGs(whichSVG,svgSubunits){for(var i=0;i<svgSubunits.length;i++){var denominator=this.svgMaxAverage-this.svgMinAverage;var numerator=this.svgValues[svgSubunits[i]].average-this.svgMinAverage;if(numerator<0){numerator=0};var percentage=(numerator/denominator)*100;if(percentage>100){percentage=100}else if((percentage<0)||(percentage===undefined)||(percentage===null)){percentage=0};var expressionLevel=parseFloat(numerator+this.svgMinAverage).toFixed(3);var sampleSize=this.svgValues[svgSubunits[i]].rawValues.length;this.svgValues[svgSubunits[i]].expressionLevel=expressionLevel;this.svgValues[svgSubunits[i]].sampleSize=sampleSize;var colourFill=this.percentageToColour(percentage);this.colourSVGSubunit(whichSVG,svgSubunits[i],colourFill,expressionLevel,sampleSize);this.finishedColouring=!0}};colourSVGSubunit(whichSVG,svgSubunit,colour,expressionLevel,sampleSize=1){let svgObject=document.getElementById(whichSVG+'_object').getSVGDocument();var duplicateShoot=['Control_Shoot_0_Hour','Cold_Shoot_0_Hour','Osmotic_Shoot_0_Hour','Salt_Shoot_0_Hour','Drought_Shoot_0_Hour','Genotoxic_Shoot_0_Hour','Oxidative_Shoot_0_Hour','UV-B_Shoot_0_Hour','Wounding_Shoot_0_Hour','Heat_Shoot_0_Hour'];var duplicateRoot=['Control_Root_0_Hour','Cold_Root_0_Hour','Osmotic_Root_0_Hour','Salt_Root_0_Hour','Drought_Root_0_Hour','Genotoxic_Root_0_Hour','Oxidative_Root_0_Hour','UV-B_Root_0_Hour','Wounding_Root_0_Hour','Heat_Root_0_Hour'];var isdupShoot=!1;var isdupRoot=!1;if(duplicateShoot.includes(svgSubunit)){isdupShoot=!0}else if(duplicateRoot.includes(svgSubunit)){isdupRoot=!0};var childElements;if(svgObject.getElementById(svgSubunit)===null||svgObject.getElementById(svgSubunit).childNodes===null||svgObject.getElementById(svgSubunit)===undefined||svgObject.getElementById(svgSubunit).childNodes===undefined){setTimeout(function(){if(svgObject.getElementById(svgSubunit).childNodes!=null||svgObject.getElementById(svgSubunit).childNodes!=undefined){childElements=svgObject.getElementById(svgSubunit).childNodes}},500)}else{childElements=svgObject.getElementById(svgSubunit).childNodes};if(childElements.length>0){for(var c=0;c<childElements.length;c++){if(childElements[c].nodeName==='path'||childElements[c].nodeName==='g'){childElements[c].setAttribute("fill",colour)}}}else{svgObject.getElementById(svgSubunit).setAttribute("fill",colour)};svgObject.getElementById(svgSubunit).setAttribute("class",'hoverDetails');svgObject.getElementById(svgSubunit).addEventListener('mouseenter',function(event){addTissueMetadata(this.id)});svgObject.getElementById(svgSubunit).addEventListener('mouseleave',function(event){removeTissueMetadata(this.id)});var expressionLevel=expressionLevel;svgObject.getElementById(svgSubunit).setAttribute("data-expressionValue",expressionLevel);var sampleSize=sampleSize;svgObject.getElementById(svgSubunit).setAttribute("data-sampleSize",sampleSize);var title=document.createElementNS("http://www.w3.org/2000/svg","title");title.textContent=svgSubunit+'\nExpression level: '+expressionLevel+'\nSample size: '+sampleSize;svgObject.getElementById(svgSubunit).appendChild(title);if(isdupShoot){for(var dupS=0;dupS<duplicateShoot.length;dupS++){svgObject.getElementById(duplicateShoot[dupS]).setAttribute("class",'hoverDetails');svgObject.getElementById(duplicateShoot[dupS]).addEventListener('mouseenter',function(event){addTissueMetadata(this.id)});svgObject.getElementById(duplicateShoot[dupS]).addEventListener('mouseleave',function(event){removeTissueMetadata(this.id)});var childElements=svgObject.getElementById(duplicateShoot[dupS]).childNodes;if(childElements.length>0){for(var c=0;c<childElements.length;c++){if(childElements[c].nodeName==='path'){childElements[c].setAttribute("fill",colour)}}}else{svgObject.getElementById(duplicateShoot[dupS]).setAttribute("fill",colour)};var title=document.createElementNS("http://www.w3.org/2000/svg","title");title.textContent=duplicateShoot[dupS]+'\nExpression level: '+expressionLevel+'\nSample size: '+sampleSize;svgObject.getElementById(duplicateShoot[dupS]).appendChild(title)}}else if(isdupRoot){for(var dupR=0;dupR<duplicateRoot.length;dupR++){svgObject.getElementById(duplicateRoot[dupR]).setAttribute("class",'hoverDetails');svgObject.getElementById(duplicateRoot[dupR]).addEventListener('mouseenter',function(event){addTissueMetadata(this.id)});svgObject.getElementById(duplicateRoot[dupR]).addEventListener('mouseleave',function(event){removeTissueMetadata(this.id)});var childElements=svgObject.getElementById(duplicateRoot[dupR]).childNodes;if(childElements.length>0){for(var c=0;c<childElements.length;c++){if(childElements[c].nodeName==='path'){childElements[c].setAttribute("fill",colour)}}}else{svgObject.getElementById(duplicateRoot[dupR]).setAttribute("fill",colour)};var title=document.createElementNS("http://www.w3.org/2000/svg","title");title.textContent=duplicateRoot[dupR]+'\nExpression level: '+expressionLevel+'\nSample size: '+sampleSize;svgObject.getElementById(duplicateRoot[dupR]).appendChild(title)}}};percentageToColour(percentage){var percentage=parseInt(percentage);var colourList=['#ffff00','#fffd00','#fffc00','#fff900','#fff800','#fff600','#fff500','#fff300','#fff200','#fff000','#ffee00','#ffec00','#ffeb00','#ffe800','#ffe700','#ffe600','#ffe300','#ffe100','#ffe000','#ffdf00','#ffdd00','#ffdb00','#ffda00','#ffd800','#ffd600','#ffd300','#ffd200','#ffd000','#ffcf00','#ffcc00','#ffcb00','#ffc900','#ffc700','#ffc500','#ffc300','#ffc300','#ffc000','#ffbf00','#ffbd00','#ffbb00','#ffb900','#ffb800','#ffb500','#ffb300','#ffb200','#ffb000','#ffad00','#ffac00','#ffa900','#ffa800','#ffa600','#ffa400','#ffa200','#ffa100','#ff9e00','#ff9c00','#ff9a00','#ff9900','#ff9600','#ff9400','#ff9300','#ff9000','#ff8f00','#ff8c00','#ff8900','#ff8700','#ff8600','#ff8300','#ff8200','#ff7f00','#ff7c00','#ff7b00','#ff7800','#ff7600','#ff7300','#ff7100','#ff6e00','#ff6c00','#ff6900','#ff6700','#ff6500','#ff6100','#ff5e00','#ff5c00','#ff5900','#ff5600','#ff5300','#ff5000','#ff4d00','#ff4900','#ff4600','#ff4200','#ff3d00','#ff3a00','#ff3400','#ff3000','#ff2a00','#ff2400','#ff1c00','#ff1100','#ff0000'];return(colourList[percentage])};generateSVG(svgName,locus,desiredDOMid){this.svgValues={};this.svgMax=undefined;this.svgMin=undefined;this.svgMaxAverage=undefined;this.svgMaxAverageSample=undefined;this.svgMinAverage=undefined;this.svgMinAverageSample=undefined;existingStrokeWidths={};existingStrokeColours={};this.finishedColouring=!1;if(this.clickList.includes(svgName)===!1){this.clickList.push(svgName)};this.desiredDOMid=desiredDOMid;this.retrieveOnlineBARData.loadSampleData(svgName,locus);this.updateChecker(svgName,locus)};updateChecker(svgName,locus,iteration=0){if(iteration<200){let newIt=iteration+1;let timer=setTimeout(()=>{var checkList=Object.keys(this.retrieveOnlineBARData.eFPObjects);if(checkList.length===this.clickList.length){this.addSVGtoDOM(svgName,locus);this.interactiveSVGData.retrieveTopExpressionValues(locus)}else{this.updateChecker(svgName,locus,newIt)}},100)}}};const createSVGExpressionData=new CreateSVGExpressionData()