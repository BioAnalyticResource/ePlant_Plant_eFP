let existingStrokeData={};function addTissueMetadata(e){var t,s,a;e.includes("Half_Leaf_Pseudomonas_syringae")&&(e+="_outline"),document.getElementById(createSVGExpressionData.svgObjectName)&&document.getElementById(createSVGExpressionData.svgObjectName)&&(a=(s=(t=document.getElementById(createSVGExpressionData.svgObjectName)).getElementById(e)).childNodes);var i=void 0,o=void 0;if(t&&s){if(s.getAttribute("stroke-width"))i=s.getAttribute("stroke-width"),s.getAttribute("stroke")&&(o=s.getAttribute("stroke"));else if(a.length>0)for(var r=0;r<a.length;r++)"path"===a[r].nodeName&&(a[r].getAttribute("stroke-width")&&(i=a[r].getAttribute("stroke-width")),a[r].getAttribute("stroke")&&(o=a[r].getAttribute("stroke")));if(existingStrokeData[e]||(existingStrokeData[e]={},existingStrokeData[e].strokeWidth=i,existingStrokeData[e].strokeColour=o,existingStrokeData[e].addedMetadata=!1),t.getElementById(e)&&!existingStrokeData[e].addedMetadata){existingStrokeData[e].addedMetadata=!0;var n=t.getElementById(e),l=2.25*(i=Number(i));l>2.25&&2.25>i?l=2.25:l<1.125&&1.125>i?l=1.125:0===l?l=2.25:l||(l=1.125);var d=!1;if(n.getAttribute("stroke-width"))t.getElementById(e).setAttribute("stroke-width",l),t.getElementById(e).setAttribute("stroke","#000"),d=!0;else if(a&&a.length>0)for(r=0;r<a.length;r++)"path"===a[r].nodeName&&a[r].getAttribute("stroke-width")&&(a[r].setAttribute("stroke-width",l),a[r].getAttribute("stroke")&&a[r].setAttribute("stroke","#000"),d=!0);d||(t.getElementById(e).setAttribute("stroke-width",l),t.getElementById(e).setAttribute("stroke","#000"))}}}function removeTissueMetadata(e){e.includes("Half_Leaf_Pseudomonas_syringae")&&(e+="_outline");var t,s,a;if(document.getElementById(createSVGExpressionData.svgObjectName)&&document.getElementById(createSVGExpressionData.svgObjectName)&&(a=(s=(t=document.getElementById(createSVGExpressionData.svgObjectName)).getElementById(e)).childNodes),existingStrokeData[e]&&existingStrokeData[e].addedMetadata)if(existingStrokeData[e].addedMetadata=!1,s&&s.getAttribute("stroke-width"))Number(existingStrokeData[e].strokeWidth)>=0?t.getElementById(e).setAttribute("stroke-width",existingStrokeData[e].strokeWidth):existingStrokeData[e].strokeWidth?t.getElementById(e).setAttribute("stroke-width",1):t.getElementById(e).removeAttribute("stroke-width"),s.getAttribute("stroke")&&(existingStrokeData[e].strokeColour?t.getElementById(e).setAttribute("stroke",existingStrokeData[e].strokeColour):t.getElementById(e).setAttribute("stroke","#000"));else if(a.length>0)for(var i=0;i<a.length;i++)"path"===a[i].nodeName&&(a[i].getAttribute("stroke-width")&&(Number(existingStrokeData[e].strokeWidth)>=0?a[i].setAttribute("stroke-width",existingStrokeData[e].strokeWidth):existingStrokeData[e].strokeWidth?a[i].setAttribute("stroke-width",1):t.getElementById(e).removeAttribute("stroke-width")),a[i].getAttribute("stroke")&&(existingStrokeData[e].strokeColour?a[i].setAttribute("stroke",existingStrokeData[e].strokeColour):a[i].setAttribute("stroke","#000")));else s.setAttribute("stroke-width",1),s.setAttribute("stroke","#000")}class CreateSVGExpressionData{constructor(){this.eFPObjects={},this.sampleData={},this.sampleOptions=[],this.sampleReadableName={},this.topExpressionValues={},this.expressionValues={},this.topExpressionOptions=["Microarray","RNA-seq"],this.desiredDOMid="",this.clickList=[],this.svgValues={},this.svgMax=0,this.svgMin=0,this.svgMaxAverage=0,this.svgMaxAverageSample="",this.svgMinAverage=0,this.svgMinAverageSample="",this.svgObjectName=""}generateSVG(e,t="AT3G24650",s="default",a=!0){this.svgValues={},this.svgMax=void 0,this.svgMin=void 0,this.svgMaxAverage=void 0,this.svgMaxAverageSample=void 0,this.svgMinAverage=void 0,this.svgMinAverageSample=void 0,this.includeDropdownAll=a,!1===this.clickList.includes(s)&&this.clickList.push(s),this.desiredDOMid=e,this.retrieveTopExpressionValues(s,t)}retrieveTopExpressionValues(e,t="AT3G24650"){var s=0;if(this.topExpressionValues&&this.topExpressionValues[t])Object.keys(this.topExpressionValues[t]).length>0&&this.loadSampleData(e,t);else for(var a=0;a<this.topExpressionOptions.length;a++){var i=this.topExpressionOptions[a];let n="https://bar.utoronto.ca/expression_max_api/max_average?method="+i;var o={loci:[t.toUpperCase()],method:i};o=JSON.stringify(o);var r={mode:"cors",method:"POST",headers:{}};r.headers["Content-type"]="application/json",r.body=o,fetch(n,r).then(a=>{200===a.status?a.text().then(a=>{let i;var o;i=a.length>0?JSON.parse(a):{};var r=n.split("=");if(r.length>1&&(o=r[1]),o&&i&&!0===i.wasSuccessful&&i.maxAverage){var l={};l[o]={},l[o].maxAverage=i.maxAverage[t.toUpperCase()],i.standardDeviation&&(l[o].standardDeviation=i.standardDeviation[t.toUpperCase()]),i.sample&&(l[o].sample=i.sample[t.toUpperCase()]),i.compendium&&(l[o].compendium=i.compendium[t.toUpperCase()]),this.topExpressionValues||(this.topExpressionValues={}),this.topExpressionValues[t]={...this.topExpressionValues[t],...l}}++s===this.topExpressionOptions.length&&this.loadSampleData(e,t)}):200!==a.status&&(++s===this.topExpressionOptions.length&&this.loadSampleData(e,t),console.error("fetch error - Status Code: "+a.status+", fetch-url: "+a.url+", document-url: "+window.location.href))}).catch(a=>{++s===this.topExpressionOptions.length&&this.loadSampleData(e,t),console.error(a)})}}loadSampleData(e,t){if(0===Object.keys(this.sampleData).length){fetch("https://raw.githubusercontent.com/BioAnalyticResource/ePlant_Plant_eFP/master/data/SampleData.min.json",{mode:"cors"}).then(s=>{200===s.status?s.text().then(s=>{let a;a=s.length>0?JSON.parse(s):{},this.sampleData=a,this.retrieveSampleData(e,t)}):200!==s.status&&console.error("fetch error - Status Code: "+s.status+", fetch-url: "+s.url+", document-url: "+window.location.href)}).catch(e=>{console.error(e)})}else Object.keys(this.sampleData).length>0&&this.retrieveSampleData(e,t)}retrieveSampleData(e,t){if(".svg"===e.substr(-4)&&(e=e.substr(0,e.length-4)),0===this.sampleOptions.length)for(const[e,t]of Object.entries(this.sampleData))this.sampleOptions.push(e),this.sampleReadableName[t.name]=e;var s,a=Object.keys(this.sampleData),i=[],o=[];if(!a.includes(e)&&this.topExpressionValues[t]){var r=0,n=void 0;for(const[e,s]of Object.entries(this.topExpressionValues[t]))s.compendium&&s.compendium[1]&&s.maxAverage&&s.maxAverage[1]&&s.maxAverage[1]>r&&(r=s.maxAverage[1],n=s.compendium[1]);e=n||"AbioticStress"}let l=a.indexOf(e);var d=this.sampleData[a[l]],h=d.sample;if(void 0!==(s=d.db)){o=Object.keys(d.sample),i=[];for(var u=0;u<o.length;u++)i=i.concat(h[o[u]])}this.eFPObjects[e]&&this.eFPObjects[e].locusCalled.includes(t)?this.eFPObjects[e]&&this.addSVGtoDOM(e,t,this.includeDropdownAll):this.callPlantEFP(s,t,i,e,h)}callPlantEFP(e,t,s,a,i){let o="https://bar.utoronto.ca/~asullivan/webservices/plantefp.cgi?";o+="datasource="+e+"&",o+="id="+t+"&",o+="samples=[";for(var r=0;r<s.length;r++){var n=s[r].trim();o+='"'+(n=(n=n.replace(/\+/g,"%2B")).replace(/ /g,"%20"))+'"',r!==s.length-1&&(o+=",")}o+="]";fetch(o,{mode:"cors"}).then(s=>{200===s.status?s.text().then(s=>{let o;o=s.length>0?JSON.parse(s):{};let r=Object.keys(i);void 0===this.eFPObjects&&(this.eFPObjects={}),void 0===this.eFPObjects[a]&&(this.eFPObjects[a]={}),void 0===this.eFPObjects[a].sample&&(this.eFPObjects[a].sample={}),void 0===this.eFPObjects[a].sample&&(this.eFPObjects[a].sample={});for(var n=0;n<o.length;n++){var l=o[n].name.trim(),d=o[n].value,h="",u=l;u=(u=(u=l.replace(/%2B/g,"+")).replace(/%20/g," ")).trim();for(var f=0;f<r.length;f++)i[r[f]].includes(u)&&(h=r[f],void 0===this.eFPObjects[a].sample[h]&&(this.eFPObjects[a].sample[h]={}),void 0===this.eFPObjects[a].sample[h][u]&&(this.eFPObjects[a].sample[h][u]={}),this.eFPObjects[a].sample[h][u][t]=d,this.eFPObjects.locusCalled||(this.eFPObjects.locusCalled=[]),this.eFPObjects.locusCalled.includes(t)||this.eFPObjects.locusCalled.push(t))}this.eFPObjects[a].db=e,this.addSVGtoDOM(a,t,this.includeDropdownAll)}):200!==s.status&&(this.addSVGtoDOM(a,t,this.includeDropdownAll),console.error("fetch error - Status Code: "+s.status+", fetch-url: "+s.url+", document-url: "+window.location.href))}).catch(e=>{this.addSVGtoDOM(a,t,this.includeDropdownAll),console.error(e)})}addSVGtoDOM(e,t,s=!1){var a="Klepikova",i="";""!==e&&(a=e);var o=document.getElementById(this.desiredDOMid);o.innerHTML="";var r=0;if(s&&this.sampleOptions){i+="Select SVG to display: <select onchange=\"window.createSVGExpressionData.generateSVG('"+this.desiredDOMid+"', '"+t+"', this.value.toString(), "+s+')" id="sampleOptions" value="'+e+'">';var n=Object.keys(this.sampleReadableName);if(n.sort(),this.topExpressionValues[t]&&Object.keys(this.topExpressionValues[t]).length>0){i+='<option value="hiddenOption" id="hiddenExpressionOption" disabled>Compendiums with maximum average expression:</option>';for(var l=Object.keys(this.topExpressionValues[t]),d=0;d<l.length;d++)if(this.topExpressionValues[t][l[d]])for(var h=this.topExpressionValues[t][l[d]],u=h.compendium,f=0;f<Object.keys(u).length;f++){var g=f+1;if(h.compendium[g]){var c=h.compendium[g],m=h.sample[g];if(m&&this.sampleData[c]&&this.sampleData[c]&&this.sampleData[c].description){var p=this.sampleData[c].description[m],v=h.maxAverage[g],b=this.sampleData[c].name;i+='<option value="'+c+'">'+b+": "+p+" at "+v+" ("+l[d]+")</option>";break}}}}i+='<option value="hiddenOption" id="allCompendiumOptions" disabled>All compendiums:</option>';for(d=0;d<n.length;d++)i+='<option value="'+this.sampleReadableName[n[d]]+'">'+n[d]+"</option>",this.sampleReadableName[n[d]]===e&&(r=d);i+="</select></br>"}i+="<b>"+e+"</b></br>";fetch("https://raw.githubusercontent.com/BioAnalyticResource/ePlant_Plant_eFP/master/compendiums/"+a+".min.svg",{mode:"cors"}).then(e=>{200===e.status?e.text().then(e=>{i+='<div id="'+a+'_object">',i+=e,i+="</div>",o.innerHTML=i,document.getElementsByTagName("svg")&&document.getElementsByTagName("svg")[0]&&(this.svgObjectName=document.getElementsByTagName("svg")[0].id,document.getElementById(this.svgObjectName)&&(document.getElementById(this.svgObjectName).style="width: 95% !important;height: 95% !important;"));var s=4;this.topExpressionValues[t]&&0!==Object.keys(this.topExpressionValues[t]).length||(s=1),document.getElementById("sampleOptions").selectedIndex=r+s,setTimeout(()=>{this.createLocusMatch(a,t)},200)}):200!==e.status&&console.error("fetch error - Status Code: "+e.status+", fetch-url: "+e.url+", document-url: "+window.location.href)}).catch(e=>{console.error(e)})}createLocusMatch(e,t){for(var s=t,a="",i=0;i<s.length;i++)a+=1===i||3===i?s[i].toLowerCase():s[i];this.createSVGValues(e,t)}createSVGValues(e,t){let s=[],a=this.eFPObjects[e].sample,i=Object.keys(a);for(var o=0;o<i.length;o++)s.push(a[i[o]]);for(var r=0;r<i.length;r++){var n=Object.keys(a[i[r]]);void 0===this.svgValues[i[r]]&&(this.svgValues[i[r]]={});for(var l=0;l<n.length;l++)void 0===this.svgValues[i[r]].rawValues&&(this.svgValues[i[r]].rawValues=[]),this.svgValues[i[r]].rawValues.push(a[i[r]][n[l]][t])}this.findExpressionValues(e,i)}findExpressionValues(e,t){this.svgMax=void 0,this.svgMin=void 0;for(var s=0;s<t.length;s++){for(var a=this.svgValues[t[s]].rawValues.sort(),i=[],o=0;o<a.length;o++)!1===isNaN(a[o])&&i.push(parseFloat(a[o]));for(var r=0,n=0;n<i.length;n++)r+=i[n];var l=r/i.length,d=i[i.length-1],h=i[1];void 0===this.svgMax?this.svgMax=d:d>this.svgMax&&(this.svgMax=d),void 0===this.svgMin?this.svgMin=h:h<this.svgMin&&(this.svgMin=h),void 0===this.svgMaxAverage?(this.svgMaxAverage=l,this.svgMaxAverageSample=t[s]):l>this.svgMaxAverage&&(this.svgMaxAverage=l,this.svgMaxAverageSample=t[s]),void 0===this.svgMinAverage?(this.svgMinAverage=l,this.svgMinAverageSample=t[s]):l<this.svgMinAverage&&(this.svgMinAverage=l,this.svgMinAverageSample=t[s]),void 0===this.svgValues[t[s]]&&(this.svgValues[t[s]]={}),this.svgValues[t[s]].average=l,this.svgValues[t[s]].sd=this.standardDeviationCalc(i);var u=this.sampleData[e],f=Object.keys(u.controlComparison);if(!1===f.includes(t[s])){for(var g="",c=0;c<f.length;c++)u.controlComparison[f[c]].includes(t[s])&&(g=f[c]);if(this.svgValues[g]&&this.svgValues[g].rawValues){for(var m=this.svgValues[g].rawValues,p=0,v=0;v<m.length;v++)p+=parseFloat(m[v]);var b=p/m.length,x=0,E=0;if(null!==b&&b>0&&l>0){l>b?(x=l-b,this.svgValues[t[s]].inductionValue=x):b>l&&(E=b-l,this.svgValues[t[s]].reductionValue=E);var S=l/b;this.svgValues[t[s]].expressionRatio=S,this.svgValues[t[s]].controlSampleName=g,this.svgValues[t[s]].controlAverage=b}}}}this.colourSVGs(e,t)}standardDeviationCalc(e){var t=0,s=e.length;if(s>=1){for(var a=0,i=0,o=0;o<s;o++)i+=e[o];for(var r=i/s,n=0;n<s;n++)a+=Math.pow(e[n]-r,2);t=Math.sqrt(a/s)}return t}colourSVGs(e,t){for(var s=0;s<t.length;s++){var a=this.svgMaxAverage,i=this.svgValues[t[s]].average;i<0&&(i=0);var o=null;a&&a>=0&&(o=i/a*100),o>100?o=100:o<0&&(o=0);var r=this.percentageToColour(o),n=parseFloat(i).toFixed(3),l=this.svgValues[t[s]].rawValues.length;this.svgValues[t[s]].expressionLevel=n,this.svgValues[t[s]].sampleSize=l,this.colourSVGSubunit(e,t[s],r,n,l)}}percentageToColour(e){var t=parseInt(e);if(t>=0){return["#ffff00","#fffc00","#fff900","#fff700","#fef400","#fff200","#ffef00","#feed00","#ffea00","#ffe800","#ffe500","#ffe200","#ffe000","#ffdd00","#ffdb00","#ffd800","#ffd600","#fed300","#ffd100","#ffce00","#ffcc00","#ffc900","#ffc600","#ffc400","#ffc100","#ffbf00","#ffbc00","#ffba00","#ffb700","#feb500","#ffb200","#ffaf00","#ffad00","#ffaa00","#ffa800","#ffa500","#ffa300","#ffa000","#ff9e00","#ff9b00","#ff9900","#ff9600","#ff9300","#ff9100","#ff8e00","#ff8c00","#ff8900","#ff8700","#ff8400","#ff8200","#ff7f00","#ff7c00","#ff7a00","#ff7700","#ff7500","#ff7200","#ff7000","#ff6d00","#ff6b00","#ff6800","#ff6600","#ff6300","#ff6000","#ff5e00","#ff5b00","#ff5900","#ff5600","#ff5400","#ff5100","#ff4f00","#ff4c00","#ff4900","#ff4700","#ff4400","#ff4200","#ff3f00","#ff3d00","#ff3a00","#ff3800","#ff3500","#ff3200","#ff3000","#ff2d00","#ff2b00","#ff2800","#ff2600","#ff2300","#ff2100","#ff1e00","#ff1c00","#ff1900","#ff1600","#ff1400","#ff1100","#ff0f00","#ff0c00","#ff0a00","#ff0700","#ff0500","#ff0200","#ff0000"][t]}return"#808080"}colourSVGSubunit(e,t,s,a,i=1){let o=document.getElementById(this.svgObjectName);if(o&&o.getElementById(t)){var r=createSVGExpressionData.svgValues[t],n=void 0;this.sampleData[e].description&&(n=this.sampleData[e].description[t]),void 0!==n&&""!==n||(n=t);var l,d=["Control_Shoot_0_Hour","Cold_Shoot_0_Hour","Osmotic_Shoot_0_Hour","Salt_Shoot_0_Hour","Drought_Shoot_0_Hour","Genotoxic_Shoot_0_Hour","Oxidative_Shoot_0_Hour","UV-B_Shoot_0_Hour","Wounding_Shoot_0_Hour","Heat_Shoot_0_Hour"],h=["Control_Root_0_Hour","Cold_Root_0_Hour","Osmotic_Root_0_Hour","Salt_Root_0_Hour","Drought_Root_0_Hour","Genotoxic_Root_0_Hour","Oxidative_Root_0_Hour","UV-B_Root_0_Hour","Wounding_Root_0_Hour","Heat_Root_0_Hour"],u=!1,f=!1;if(d.includes(t)?u=!0:h.includes(t)&&(f=!0),o.getElementById(t)&&o.getElementById(t).childNodes?l=o.getElementById(t).childNodes:setTimeout(function(){o.getElementById(t)&&o.getElementById(t).childNodes&&(l=o.getElementById(t).childNodes)},500),l&&l.length>0)for(var g=0;g<l.length;g++)"path"!==l[g].nodeName&&"g"!==l[g].nodeName||l[g].setAttribute("fill",s);else o&&o.getElementById(t)&&o.getElementById(t).setAttribute("fill",s);o.getElementById(t).setAttribute("class","hoverDetails"),o.getElementById(t).addEventListener("mouseenter",function(e){addTissueMetadata(this.id)}),o.getElementById(t).addEventListener("mouseleave",function(e){removeTissueMetadata(this.id)}),o.getElementById(t).setAttribute("data-expressionValue",a),o.getElementById(t).setAttribute("data-sampleSize",i),o.getElementById(t).setAttribute("data-standardDeviation",r.sd),o.getElementById(t).setAttribute("data-sampleSize",i);var c=document.createElementNS("http://www.w3.org/2000/svg","title");c.textContent=n+"\nExpression level: "+a+"\nSample size: "+i+"\nStandardDeviation: "+parseFloat(r.sd).toFixed(3);var m=!1;if(r.inductionValue?(o.getElementById(t).setAttribute("data-inductionValue",r.inductionValue),c.textContent+="\nInduction Value: "+parseFloat(r.inductionValue).toFixed(3),m=!0):r.reductionValue&&(o.getElementById(t).setAttribute("data-reductionValue",r.reductionValue),c.textContent+="\nReduction Value: "+parseFloat(r.ReductionValue).toFixed(3),m=!0),!0===m){o.getElementById(t).setAttribute("data-expressionRatio",r.expressionRatio),c.textContent+="\nExpression Ratio: "+parseFloat(r.expressionRatio).toFixed(3),o.getElementById(t).setAttribute("data-controlSampleName",r.controlSampleName);var p=void 0;this.sampleData[e].description&&(p=this.sampleData[e].description[r.controlSampleName]),void 0!==p&&""!==p||(p=r.controlSampleName),c.textContent+="\nControl Sample Name: "+p,o.getElementById(t).setAttribute("data-controlAverage",r.controlAverage),c.textContent+="\nControl Expression: "+parseFloat(r.controlAverage).toFixed(3)}if(o.getElementById(t).appendChild(c),u){for(var v=0;v<d.length;v++)if(o.getElementById(d[v])){if(o.getElementById(d[v]).setAttribute("class","hoverDetails"),o.getElementById(d[v]).addEventListener("mouseenter",function(e){addTissueMetadata(this.id)}),o.getElementById(d[v]).addEventListener("mouseleave",function(e){removeTissueMetadata(this.id)}),(l=o.getElementById(d[v]).childNodes).length>0)for(g=0;g<l.length;g++)"path"===l[g].nodeName&&l[g].setAttribute("fill",s);else o.getElementById(d[v]).setAttribute("fill",s);c.textContent=d[v]+"\nExpression level: "+a+"\nSample size: "+i,o.getElementById(d[v]).appendChild(c)}}else if(f)for(var b=0;b<h.length;b++){if(o.getElementById(h[b]).setAttribute("class","hoverDetails"),o.getElementById(h[b]).addEventListener("mouseenter",function(e){addTissueMetadata(this.id)}),o.getElementById(h[b]).addEventListener("mouseleave",function(e){removeTissueMetadata(this.id)}),(l=o.getElementById(h[b]).childNodes).length>0)for(g=0;g<l.length;g++)"path"===l[g].nodeName&&l[g].setAttribute("fill",s);else o.getElementById(h[b]).setAttribute("fill",s);c.textContent=h[b]+"\nExpression level: "+a+"\nSample size: "+i,o.getElementById(h[b]).appendChild(c)}}}}let createSVGExpressionData=new CreateSVGExpressionData;window.createSVGExpressionData=createSVGExpressionData;