let existingStrokeData={};function addTissueMetadata(e){var t,s,a;e.includes("Half_Leaf_Pseudomonas_syringae")&&(e+="_outline"),document.getElementById(createSVGExpressionData.svgObjectName)&&document.getElementById(createSVGExpressionData.svgObjectName).getSVGDocument()&&(a=(s=(t=document.getElementById(createSVGExpressionData.svgObjectName).getSVGDocument()).getElementById(e)).childNodes);var i=void 0,o=void 0,r=!1;if(t&&a&&a.length>0){var n;if(s.getAttribute("stroke-width")&&(i=s.getAttribute("stroke-width"),r=!0),s.getAttribute("stroke")&&(o=s.getAttribute("stroke"),r=!0),!1===r)for(var l=0;l<a.length;l++)"path"===a[l].nodeName&&(a[l].getAttribute("stroke-width")&&(i=a[l].getAttribute("stroke-width"),r=!0),a[l].getAttribute("stroke")&&(o=a[l].getAttribute("stroke"),r=!0));if(n=e,r&&(null!=i&&0!==existingStrokeData||(i=1),null==o&&(o="none"),void 0===existingStrokeData[e]?(existingStrokeData[e]={},existingStrokeData[e].strokeDataExist=r,existingStrokeData[e].strokeWidth=i,existingStrokeData[e].strokeColour=o,existingStrokeData[e].strokeID=n):(existingStrokeData[e].strokeDataExist=r,existingStrokeData[e].strokeWidth=i,existingStrokeData[e].strokeColour=o,existingStrokeData[e].strokeID=n),t.getElementById(existingStrokeData[e].strokeID))){var d=1.5*i;(d<5||0===d)&&(d=2.25);var f=!1;if(t.getElementById(existingStrokeData[e].strokeID).getAttribute("stroke-width"))t.getElementById(existingStrokeData[e].strokeID).setAttribute("stroke-width",d),t.getElementById(existingStrokeData[e].strokeID).setAttribute("stroke","#000000"),f=!0;else if(t&&a&&a.length>0)for(l=0;l<a.length;l++)"path"===a[l].nodeName&&(a[l].getAttribute("stroke-width")&&(a[l].setAttribute("stroke-width",d),f=!0),a[l].getAttribute("stroke")&&a[l].setAttribute("stroke","#000000"));!1===f&&(t.getElementById(existingStrokeData[e].strokeID).setAttribute("stroke-width",d),t.getElementById(existingStrokeData[e].strokeID).setAttribute("stroke","#000000"))}}}function removeTissueMetadata(e){var t,s,a;e.includes("Half_Leaf_Pseudomonas_syringae")&&(e+="_outline"),document.getElementById(createSVGExpressionData.svgObjectName)&&document.getElementById(createSVGExpressionData.svgObjectName).getSVGDocument()&&(a=(s=(t=document.getElementById(createSVGExpressionData.svgObjectName).getSVGDocument()).getElementById(e)).childNodes);var i=!1;if((!1===i||a.length<=0||null===a)&&(s.getAttribute("stroke-width")&&existingStrokeData[e]&&existingStrokeData[e].strokeWidth&&parseFloat(existingStrokeData[e].strokeWidth)>=0&&(t.getElementById(existingStrokeData[e].strokeID).setAttribute("stroke-width",existingStrokeData[e].strokeWidth),i=!0),s.getAttribute("stroke")&&existingStrokeData[e]&&existingStrokeData[e].strokeColour&&t.getElementById(existingStrokeData[e].strokeID).setAttribute("stroke",existingStrokeData[e].strokeColour)),!1===i&&a.length>0)for(var o=0;o<a.length;o++)"path"===a[o].nodeName&&(a[o].getAttribute("stroke-width")&&existingStrokeData[e].strokeWidth&&parseFloat(existingStrokeData[e].strokeWidth)>=0?(a[o].setAttribute("stroke-width",existingStrokeData[e].strokeWidth),i=!0):a[o].getAttribute("stroke-width")&&(a[o].setAttribute("stroke-width",1.5),i=!0),a[o].getAttribute("stroke")&&existingStrokeData[e].strokeColour?a[o].setAttribute("stroke",existingStrokeData[e].strokeColour):a[o].getAttribute("stroke")&&a[o].setAttribute("stroke","#000000"));!1===i&&(s.setAttribute("stroke-width",1.5),s.setAttribute("stroke","#000000"))}class CreateSVGExpressionData{constructor(){this.eFPObjects={},this.sampleData={},this.sampleOptions=[],this.sampleReadableName={},this.topExpressionValues={},this.expressionValues={},this.topExpressionOptions=["Microarray","RNA-seq"],this.desiredDOMid="",this.clickList=[],this.svgValues={},this.svgMax=0,this.svgMin=0,this.svgMaxAverage=0,this.svgMaxAverageSample="",this.svgMinAverage=0,this.svgMinAverageSample="",this.svgObjectName=""}retrieveTopExpressionValues(e,t="AT3G24650"){var s=0;if(0===Object.keys(this.topExpressionValues).length||void 0===this.topExpressionValues)for(var a=0;a<this.topExpressionOptions.length;a++){var i=this.topExpressionOptions[a];let n="https://bar.utoronto.ca/expression_max_api/max_average?method="+i;var o={loci:[t.toUpperCase()],method:i};o=JSON.stringify(o);var r={mode:"cors",method:"POST",headers:{}};r.headers["Content-type"]="application/json",r.body=o,fetch(n,r).then(a=>{200===a.status?a.json().then(a=>{let i=a;var o,r=n.split("=");if(r.length>1&&(o=r[1]),o&&i&&!0===i.wasSuccessful&&i.maxAverage){var l={};l[o]={},l[o].maxAverage=i.maxAverage[t.toUpperCase()],i.standardDeviation&&(l[o].standardDeviation=i.standardDeviation[t.toUpperCase()]),i.sample&&(l[o].sample=i.sample[t.toUpperCase()]),i.compendium&&(l[o].compendium=i.compendium[t.toUpperCase()]),this.topExpressionValues=Object.assign(this.topExpressionValues,l)}if(++s===this.topExpressionOptions.length){if("default"===e.trim().toLowerCase()){var d=0,f=void 0;for(const[e,t]of Object.entries(this.topExpressionValues))t.compendium&&t.compendium[1]&&t.maxAverage&&t.maxAverage[1]&&t.maxAverage[1]>d&&(d=t.maxAverage[1],f=t.compendium[1]);e=f||"AbioticStress"}this.loadSampleData(e,t)}}):200!==a.status&&(++s===this.topExpressionOptions.length&&this.loadSampleData(e,t),console.error("fetch error - Status Code: "+a.status+", fetch-url: "+a.url+", document-url: "+window.location.href))}).catch(a=>{++s===this.topExpressionOptions.length&&this.loadSampleData(e,t),console.error(a)})}else Object.keys(this.topExpressionValues).length>0&&this.loadSampleData(e,t)}loadSampleData(e,t){if(0===Object.keys(this.sampleData).length){fetch("https://raw.githubusercontent.com/BioAnalyticResource/ePlant_Plant_eFP/master/data/SampleData.min.json",{mode:"cors"}).then(s=>{200===s.status?s.json().then(s=>{this.sampleData=s,this.retrieveSampleData(e,t)}):200!==s.status&&console.error("fetch error - Status Code: "+s.status+", fetch-url: "+s.url+", document-url: "+window.location.href)}).catch(e=>{console.error(e)})}else Object.keys(this.sampleData).length>0&&this.retrieveSampleData(e,t)}retrieveSampleData(e,t){if(".svg"===e.substr(-4)&&(e=e.substr(0,e.length-4)),0===this.sampleOptions.length)for(const[e,t]of Object.entries(this.sampleData))this.sampleOptions.push(e),this.sampleReadableName[t.name]=e;var s=Object.keys(this.sampleData),a="",i=[],o=[];if(s.includes(e)){let d=s.indexOf(e);var r=this.sampleData[s[d]],n=r.sample;if(void 0!==(a=r.db)){o=Object.keys(r.sample),i=[];for(var l=0;l<o.length;l++)i=i.concat(n[o[l]])}void 0===this.eFPObjects[e]?this.callPlantEFP(a,t,i,e,n):this.eFPObjects[e]&&this.addSVGtoDOM(e,t,this.includeDropdownAll)}}callPlantEFP(e,t,s,a,i){let o="https://bar.utoronto.ca/~asullivan/webservices/plantefp.cgi?";o+="datasource="+e+"&",o+="id="+t+"&",o+="samples=[";for(var r=0;r<s.length;r++){var n=s[r].trim();o+='"'+(n=(n=n.replace(/\+/g,"%2B")).replace(/ /g,"%20"))+'"',r!==s.length-1&&(o+=",")}o+="]";fetch(o,{mode:"cors"}).then(s=>{200===s.status?s.json().then(s=>{let o=Object.keys(i);var r=s;void 0===this.eFPObjects&&(this.eFPObjects={}),void 0===this.eFPObjects[a]&&(this.eFPObjects[a]={}),void 0===this.eFPObjects[a].sample&&(this.eFPObjects[a].sample={}),void 0===this.eFPObjects[a].sample&&(this.eFPObjects[a].sample={});for(var n=0;n<r.length;n++){var l=r[n].name.trim(),d=r[n].value,f="",h=l;h=(h=(h=l.replace(/%2B/g,"+")).replace(/%20/g," ")).trim();for(var u=0;u<o.length;u++)i[o[u]].includes(h)&&(f=o[u],void 0===this.eFPObjects[a].sample[f]&&(this.eFPObjects[a].sample[f]={}),void 0===this.eFPObjects[a].sample[f][h]&&(this.eFPObjects[a].sample[f][h]={}),this.eFPObjects[a].sample[f][h][t]=d)}this.eFPObjects[a].db=e,this.addSVGtoDOM(a,t,this.includeDropdownAll)}):200!==s.status&&(this.addSVGtoDOM(a,t,this.includeDropdownAll),console.error("fetch error - Status Code: "+s.status+", fetch-url: "+s.url+", document-url: "+window.location.href))}).catch(e=>{this.addSVGtoDOM(a,t,this.includeDropdownAll),console.error(e)})}addSVGtoDOM(e,t,s=!1){var a="Klepikova",i="";""!==e&&(a=e);var o=document.getElementById(this.desiredDOMid);o.innerHTML="";var r=0;if(s&&this.sampleOptions){i+="Select SVG to display: <select onchange=\"createSVGExpressionData.generateSVG('"+this.desiredDOMid+"', this.value.toString(), '"+t+"', "+s+')" id="sampleOptions" value="'+e+'">';var n=Object.keys(this.sampleReadableName);if(n.sort(),this.topExpressionValues&&Object.keys(this.topExpressionValues).length>0){i+='<option value="hiddenOption" id="hiddenExpressionOption" disabled>Compendiums with maximum average expression:</option>';for(var l=Object.keys(this.topExpressionValues),d=0;d<l.length;d++)if(this.topExpressionValues[l[d]])for(var f=this.topExpressionValues[l[d]],h=f.compendium,u=0;u<Object.keys(h).length;u++){var g=u+1;if(f.compendium[g]){var c=f.compendium[g],p=f.sample[g];if(p&&this.sampleData[c]&&this.sampleData[c]&&this.sampleData[c].description){var v=this.sampleData[c].description[p],m=f.maxAverage[g];i+='<option value="'+c+'">'+this.sampleData[c].name+": "+v+" at "+m+" ("+l[d]+")</option>";break}}}}i+='<option value="hiddenOption" id="allCompendiumOptions" disabled>All compendiums:</option>';for(d=0;d<n.length;d++)i+='<option value="'+this.sampleReadableName[n[d]]+'">'+n[d]+"</option>",this.sampleReadableName[n[d]]===e&&(r=d);i+="</select></br>"}i+="<b>"+e+"</b></br>",i+='<object alt="SVG for '+a+'" id="'+a+'_object" data="'+("https://bar.utoronto.ca/~asullivan/ePlant_Plant_eFP/compendiums/"+a+".min.svg")+'" type="image/svg+xml"></object>',o.innerHTML=i;var b=4;this.topExpressionValues&&0!==Object.keys(this.topExpressionValues).length||(b=1),document.getElementById("sampleOptions").selectedIndex=r+b,this.svgObjectName=a+"_object";for(var x=!1;!1===x;)if(""!==o.innerHTML){x=!0,document.getElementById(a+"_object").style="width: 100%; height: 100%; left: 0px; top: 0px; display: inline-block;";setTimeout(()=>{this.createLocusMatch(a,t)},200)}}createLocusMatch(e,t){for(var s=t,a="",i=0;i<s.length;i++)a+=1===i||3===i?s[i].toLowerCase():s[i];this.createSVGValues(e,t)}createSVGValues(e,t){let s=[],a=this.eFPObjects[e].sample,i=Object.keys(a);for(var o=0;o<i.length;o++)s.push(a[i[o]]);for(var r=0;r<i.length;r++){var n=Object.keys(a[i[r]]);void 0===this.svgValues[i[r]]&&(this.svgValues[i[r]]={});for(var l=0;l<n.length;l++)void 0===this.svgValues[i[r]].rawValues&&(this.svgValues[i[r]].rawValues=[]),this.svgValues[i[r]].rawValues.push(a[i[r]][n[l]][t])}this.findExpressionValues(e,i)}standardDeviationCalc(e){var t=0,s=e.length;if(s>=1){for(var a=0,i=0,o=0;o<s;o++)i+=e[o];for(var r=i/s,n=0;n<s;n++)a+=Math.pow(e[n]-r,2);t=Math.sqrt(a/s)}return t}findExpressionValues(e,t){this.svgMax=void 0,this.svgMin=void 0;for(var s=0;s<t.length;s++){for(var a=this.svgValues[t[s]].rawValues.sort(),i=[],o=0;o<a.length;o++)!1===isNaN(a[o])&&i.push(parseFloat(a[o]));for(var r=0,n=0;n<i.length;n++)r+=i[n];var l=r/i.length,d=i[i.length-1],f=i[1];void 0===this.svgMax?this.svgMax=d:d>this.svgMax&&(this.svgMax=d),void 0===this.svgMin?this.svgMin=f:f<this.svgMin&&(this.svgMin=f),void 0===this.svgMaxAverage?(this.svgMaxAverage=l,this.svgMaxAverageSample=t[s]):l>this.svgMaxAverage&&(this.svgMaxAverage=l,this.svgMaxAverageSample=t[s]),void 0===this.svgMinAverage?(this.svgMinAverage=l,this.svgMinAverageSample=t[s]):l<this.svgMinAverage&&(this.svgMinAverage=l,this.svgMinAverageSample=t[s]),void 0===this.svgValues[t[s]]&&(this.svgValues[t[s]]={}),this.svgValues[t[s]].average=l,this.svgValues[t[s]].sd=this.standardDeviationCalc(i);var h=this.sampleData[e],u=Object.keys(h.controlComparison);if(!1===u.includes(t[s])){for(var g="",c=0;c<u.length;c++)h.controlComparison[u[c]].includes(t[s])&&(g=u[c]);if(this.svgValues[g]&&this.svgValues[g].rawValues){for(var p=this.svgValues[g].rawValues,v=0,m=0;m<p.length;m++)v+=parseFloat(p[m]);var b=v/p.length,x=0,S=0;if(null!==b&&b>0&&l>0){l>b?(x=l-b,this.svgValues[t[s]].inductionValue=x):b>l&&(S=b-l,this.svgValues[t[s]].reductionValue=S);var D=l/b;this.svgValues[t[s]].expressionRatio=D,this.svgValues[t[s]].controlSampleName=g,this.svgValues[t[s]].controlAverage=b}}}}this.colourSVGs(e,t)}colourSVGs(e,t){for(var s=0;s<t.length;s++){var a=this.svgMaxAverage-this.svgMinAverage,i=this.svgValues[t[s]].average-this.svgMinAverage;i<0&&(i=0);var o=i/a*100;o>100?o=100:(o<0||null==o)&&(o=0);var r=parseFloat(i+this.svgMinAverage).toFixed(3),n=this.svgValues[t[s]].rawValues.length;this.svgValues[t[s]].expressionLevel=r,this.svgValues[t[s]].sampleSize=n;var l=this.percentageToColour(o);this.colourSVGSubunit(e,t[s],l,r,n)}}colourSVGSubunit(e,t,s,a,i=1){let o=document.getElementById(e+"_object").getSVGDocument();if(o&&o.getElementById(t)){var r=createSVGExpressionData.svgValues[t],n=void 0;this.sampleData[e].description&&(n=this.sampleData[e].description[t]),void 0!==n&&""!==n||(n=t);var l,d=["Control_Shoot_0_Hour","Cold_Shoot_0_Hour","Osmotic_Shoot_0_Hour","Salt_Shoot_0_Hour","Drought_Shoot_0_Hour","Genotoxic_Shoot_0_Hour","Oxidative_Shoot_0_Hour","UV-B_Shoot_0_Hour","Wounding_Shoot_0_Hour","Heat_Shoot_0_Hour"],f=["Control_Root_0_Hour","Cold_Root_0_Hour","Osmotic_Root_0_Hour","Salt_Root_0_Hour","Drought_Root_0_Hour","Genotoxic_Root_0_Hour","Oxidative_Root_0_Hour","UV-B_Root_0_Hour","Wounding_Root_0_Hour","Heat_Root_0_Hour"],h=!1,u=!1;if(d.includes(t)?h=!0:f.includes(t)&&(u=!0),o.getElementById(t)&&o.getElementById(t).childNodes?l=o.getElementById(t).childNodes:setTimeout(function(){o.getElementById(t)&&o.getElementById(t).childNodes&&(l=o.getElementById(t).childNodes)},500),l&&l.length>0)for(var g=0;g<l.length;g++)"path"!==l[g].nodeName&&"g"!==l[g].nodeName||l[g].setAttribute("fill",s);else o&&o.getElementById(t)&&o.getElementById(t).setAttribute("fill",s);o.getElementById(t).setAttribute("class","hoverDetails"),o.getElementById(t).addEventListener("mouseenter",function(e){addTissueMetadata(this.id)}),o.getElementById(t).addEventListener("mouseleave",function(e){removeTissueMetadata(this.id)}),o.getElementById(t).setAttribute("data-expressionValue",a),o.getElementById(t).setAttribute("data-sampleSize",i),o.getElementById(t).setAttribute("data-standardDeviation",r.sd),o.getElementById(t).setAttribute("data-sampleSize",i);var c=document.createElementNS("http://www.w3.org/2000/svg","title");c.textContent=n+"\nExpression level: "+a+"\nSample size: "+i+"\nStandardDeviation: "+parseFloat(r.sd).toFixed(3);var p=!1;if(r.inductionValue?(o.getElementById(t).setAttribute("data-inductionValue",r.inductionValue),c.textContent+="\nInduction Value: "+parseFloat(r.inductionValue).toFixed(3),p=!0):r.reductionValue&&(o.getElementById(t).setAttribute("data-reductionValue",r.reductionValue),c.textContent+="\nReduction Value: "+parseFloat(r.ReductionValue).toFixed(3),p=!0),!0===p){o.getElementById(t).setAttribute("data-expressionRatio",r.expressionRatio),c.textContent+="\nExpression Ratio: "+parseFloat(r.expressionRatio).toFixed(3),o.getElementById(t).setAttribute("data-controlSampleName",r.controlSampleName);var v=void 0;this.sampleData[e].description&&(v=this.sampleData[e].description[r.controlSampleName]),void 0!==v&&""!==v||(v=r.controlSampleName),c.textContent+="\nControl Sample Name: "+v,o.getElementById(t).setAttribute("data-controlAverage",r.controlAverage),c.textContent+="\nControl Expression: "+parseFloat(r.controlAverage).toFixed(3)}if(o.getElementById(t).appendChild(c),h){for(var m=0;m<d.length;m++)if(o.getElementById(d[m])){if(o.getElementById(d[m]).setAttribute("class","hoverDetails"),o.getElementById(d[m]).addEventListener("mouseenter",function(e){addTissueMetadata(this.id)}),o.getElementById(d[m]).addEventListener("mouseleave",function(e){removeTissueMetadata(this.id)}),(l=o.getElementById(d[m]).childNodes).length>0)for(g=0;g<l.length;g++)"path"===l[g].nodeName&&l[g].setAttribute("fill",s);else o.getElementById(d[m]).setAttribute("fill",s);c.textContent=d[m]+"\nExpression level: "+a+"\nSample size: "+i,o.getElementById(d[m]).appendChild(c)}}else if(u)for(var b=0;b<f.length;b++){if(o.getElementById(f[b]).setAttribute("class","hoverDetails"),o.getElementById(f[b]).addEventListener("mouseenter",function(e){addTissueMetadata(this.id)}),o.getElementById(f[b]).addEventListener("mouseleave",function(e){removeTissueMetadata(this.id)}),(l=o.getElementById(f[b]).childNodes).length>0)for(g=0;g<l.length;g++)"path"===l[g].nodeName&&l[g].setAttribute("fill",s);else o.getElementById(f[b]).setAttribute("fill",s);c.textContent=f[b]+"\nExpression level: "+a+"\nSample size: "+i,o.getElementById(f[b]).appendChild(c)}}}percentageToColour(e){return["#ffff00","#fffd00","#fffc00","#fff900","#fff800","#fff600","#fff500","#fff300","#fff200","#fff000","#ffee00","#ffec00","#ffeb00","#ffe800","#ffe700","#ffe600","#ffe300","#ffe100","#ffe000","#ffdf00","#ffdd00","#ffdb00","#ffda00","#ffd800","#ffd600","#ffd300","#ffd200","#ffd000","#ffcf00","#ffcc00","#ffcb00","#ffc900","#ffc700","#ffc500","#ffc300","#ffc300","#ffc000","#ffbf00","#ffbd00","#ffbb00","#ffb900","#ffb800","#ffb500","#ffb300","#ffb200","#ffb000","#ffad00","#ffac00","#ffa900","#ffa800","#ffa600","#ffa400","#ffa200","#ffa100","#ff9e00","#ff9c00","#ff9a00","#ff9900","#ff9600","#ff9400","#ff9300","#ff9000","#ff8f00","#ff8c00","#ff8900","#ff8700","#ff8600","#ff8300","#ff8200","#ff7f00","#ff7c00","#ff7b00","#ff7800","#ff7600","#ff7300","#ff7100","#ff6e00","#ff6c00","#ff6900","#ff6700","#ff6500","#ff6100","#ff5e00","#ff5c00","#ff5900","#ff5600","#ff5300","#ff5000","#ff4d00","#ff4900","#ff4600","#ff4200","#ff3d00","#ff3a00","#ff3400","#ff3000","#ff2a00","#ff2400","#ff1c00","#ff1100","#ff0000"][parseInt(e)]}generateSVG(e,t="default",s="AT3G24650",a=!0){this.svgValues={},this.svgMax=void 0,this.svgMin=void 0,this.svgMaxAverage=void 0,this.svgMaxAverageSample=void 0,this.svgMinAverage=void 0,this.svgMinAverageSample=void 0,this.includeDropdownAll=a,!1===this.clickList.includes(t)&&this.clickList.push(t),this.desiredDOMid=e,this.retrieveTopExpressionValues(t,s)}}const createSVGExpressionData=new CreateSVGExpressionData;