class RetrieveOnlineBARData{constructor(){this.eFPObjects={},this.sampleData={},this.sampleOptions=[]}loadSampleData(e,t,s=!0){if(0===Object.keys(this.sampleData).length){let s=new XMLHttpRequest,a="https://raw.githubusercontent.com/BioAnalyticResource/ePlant_Plant_eFP/master/data/SampleData.min.json";s.responseType="json",s.onreadystatechange=(()=>{s.readyState===XMLHttpRequest.DONE&&200===s.status&&(this.sampleData=s.response,this.retrieveSampleData(e,t))}),s.open("GET",a),s.send()}Object.keys(this.sampleData).length>0&&s&&this.retrieveSampleData(e,t)}retrieveSampleData(e,t){".svg"===e.substr(-4)&&(e=e.substr(0,e.length-4));var s=Object.keys(this.sampleData);this.sampleOptions=s;var a="",i=[],o=[];if(s.includes(e)){let d=s.indexOf(e);var r=this.sampleData[s[d]],n=r.sample;if(void 0!==(a=r.db)){o=Object.keys(r.sample),i=[];for(var l=0;l<o.length;l++)i=i.concat(n[o[l]])}void 0===this.eFPObjects[e]&&this.callPlantEFP(a,t,i,e,n)}}callPlantEFP(e,t,s,a,i){let o=new XMLHttpRequest,r="https://bar.utoronto.ca/~asullivan/webservices/plantefp.cgi?";r+="datasource="+e+"&",r+="id="+t+"&",r+="samples=[";for(var n=0;n<s.length;n++){var l=s[n].trim();r+='"'+(l=(l=l.replace(/\+/g,"%2B")).replace(/ /g,"%20"))+'"',n!==s.length-1&&(r+=",")}r+="]",o.responseType="json",o.onreadystatechange=(()=>{if(o.readyState===XMLHttpRequest.DONE&&200===o.status){let u=Object.keys(i);var s=o.response;void 0===this.eFPObjects&&(this.eFPObjects={}),void 0===this.eFPObjects[a]&&(this.eFPObjects[a]={}),void 0===this.eFPObjects[a].sample&&(this.eFPObjects[a].sample={}),void 0===this.eFPObjects[a].sample&&(this.eFPObjects[a].sample={});for(var r=0;r<s.length;r++){var n=s[r].name.trim(),l=s[r].value,d="",f=n;f=(f=(f=n.replace(/%2B/g,"+")).replace(/%20/g," ")).trim();for(var g=0;g<u.length;g++)i[u[g]].includes(f)&&(d=u[g],void 0===this.eFPObjects[a].sample[d]&&(this.eFPObjects[a].sample[d]={}),void 0===this.eFPObjects[a].sample[d][f]&&(this.eFPObjects[a].sample[d][f]={}),this.eFPObjects[a].sample[d][f][t]=l)}this.eFPObjects[a].db=e}}),o.open("GET",r),o.send()}}class InteractiveSVGData{constructor(){this.topExpressionValues={},this.expressionValues={}}retrieveTopExpressionValues(e="AT3G24650"){0!==Object.keys(this.topExpressionValues).length&&void 0!==this.topExpressionValues||(this.retrieveTopMicroarray(e),this.retrieveTopRNASeq(e))}retrieveTopMicroarray(e="AT3G24650"){let t=new XMLHttpRequest;var s={loci:[e.toUpperCase()],method:"Microarray"};s=JSON.stringify(s),t.responseType="json",t.onreadystatechange=(()=>{if(t.readyState===XMLHttpRequest.DONE&&200===t.status){let a=t.response;if(a&&!0===a.wasSuccessful&&a.maxAverage){var s={Microarray:{maxAverage:a.maxAverage[e.toUpperCase()]}};a.standardDeviation&&(s.Microarray.standardDeviation=a.standardDeviation[e.toUpperCase()]),a.sample&&(s.Microarray.sample=a.sample[e.toUpperCase()]),a.compendium&&(s.Microarray.compendium=a.compendium[e.toUpperCase()]),this.topExpressionValues=Object.assign(this.topExpressionValues,s)}}}),t.open("POST","https://bar.utoronto.ca/expression_max_api/max_average",!0),t.setRequestHeader("Content-Type","application/json"),t.send(s)}retrieveTopRNASeq(e="AT3G24650"){let t=new XMLHttpRequest;var s={loci:[e.toUpperCase()],method:"RNA-seq"};s=JSON.stringify(s),t.responseType="json",t.onreadystatechange=(()=>{if(t.readyState===XMLHttpRequest.DONE&&200===t.status){let a=t.response;if(a&&!0===a.wasSuccessful&&a.maxAverage){var s={"RNA-seq":{maxAverage:a.maxAverage[e.toUpperCase()]}};a.standardDeviation&&(s["RNA-seq"].standardDeviation=a.standardDeviation[e.toUpperCase()]),a.sample&&(s["RNA-seq"].sample=a.sample[e.toUpperCase()]),a.compendium&&(s["RNA-seq"].compendium=a.compendium[e.toUpperCase()]),this.topExpressionValues=Object.assign(this.topExpressionValues,s)}}}),t.open("POST","https://bar.utoronto.ca/expression_max_api/max_average",!0),t.setRequestHeader("Content-Type","application/json"),t.send(s)}}let existingStrokeData={};function addTissueMetadata(e){var t,s,a;e.includes("Half_Leaf_Pseudomonas_syringae")&&(e+="_outline"),document.getElementById(createSVGExpressionData.svgObjectName)&&document.getElementById(createSVGExpressionData.svgObjectName).getSVGDocument()&&(a=(s=(t=document.getElementById(createSVGExpressionData.svgObjectName).getSVGDocument()).getElementById(e)).childNodes);var i=void 0,o=void 0,r=!1;if(t&&a&&a.length>0){var n;if(s.getAttribute("stroke-width")&&(i=s.getAttribute("stroke-width"),r=!0),s.getAttribute("stroke")&&(o=s.getAttribute("stroke"),r=!0),!1===r)for(var l=0;l<a.length;l++)"path"===a[l].nodeName&&(a[l].getAttribute("stroke-width")&&(i=a[l].getAttribute("stroke-width"),r=!0),a[l].getAttribute("stroke")&&(o=a[l].getAttribute("stroke"),r=!0));if(n=e,r&&(null!=i&&0!==existingStrokeData||(i=1),null==o&&(o="none"),void 0===existingStrokeData[e]?(existingStrokeData[e]={},existingStrokeData[e].strokeDataExist=r,existingStrokeData[e].strokeWidth=i,existingStrokeData[e].strokeColour=o,existingStrokeData[e].strokeID=n):(existingStrokeData[e].strokeDataExist=r,existingStrokeData[e].strokeWidth=i,existingStrokeData[e].strokeColour=o,existingStrokeData[e].strokeID=n),t.getElementById(existingStrokeData[e].strokeID))){var d=1.5*i;(d<5||0===d)&&(d=2.25);var f=!1;if(t.getElementById(existingStrokeData[e].strokeID).getAttribute("stroke-width"))t.getElementById(existingStrokeData[e].strokeID).setAttribute("stroke-width",d),t.getElementById(existingStrokeData[e].strokeID).setAttribute("stroke","#000000"),f=!0;else if(t&&a&&a.length>0)for(l=0;l<a.length;l++)"path"===a[l].nodeName&&(a[l].getAttribute("stroke-width")&&(a[l].setAttribute("stroke-width",d),f=!0),a[l].getAttribute("stroke")&&a[l].setAttribute("stroke","#000000"));!1===f&&(t.getElementById(existingStrokeData[e].strokeID).setAttribute("stroke-width",d),t.getElementById(existingStrokeData[e].strokeID).setAttribute("stroke","#000000"))}}}function removeTissueMetadata(e){var t,s,a;e.includes("Half_Leaf_Pseudomonas_syringae")&&(e+="_outline"),document.getElementById(createSVGExpressionData.svgObjectName)&&document.getElementById(createSVGExpressionData.svgObjectName).getSVGDocument()&&(a=(s=(t=document.getElementById(createSVGExpressionData.svgObjectName).getSVGDocument()).getElementById(e)).childNodes);var i=!1;if((!1===i||a.length<=0||null===a)&&(s.getAttribute("stroke-width")&&existingStrokeData[e]&&existingStrokeData[e].strokeWidth&&parseFloat(existingStrokeData[e].strokeWidth)>=0&&(t.getElementById(existingStrokeData[e].strokeID).setAttribute("stroke-width",existingStrokeData[e].strokeWidth),i=!0),s.getAttribute("stroke")&&existingStrokeData[e]&&existingStrokeData[e].strokeColour&&t.getElementById(existingStrokeData[e].strokeID).setAttribute("stroke",existingStrokeData[e].strokeColour)),!1===i&&a.length>0)for(var o=0;o<a.length;o++)"path"===a[o].nodeName&&(a[o].getAttribute("stroke-width")&&existingStrokeData[e].strokeWidth&&parseFloat(existingStrokeData[e].strokeWidth)>=0?(a[o].setAttribute("stroke-width",existingStrokeData[e].strokeWidth),i=!0):a[o].getAttribute("stroke-width")&&(a[o].setAttribute("stroke-width",1.5),i=!0),a[o].getAttribute("stroke")&&existingStrokeData[e].strokeColour?a[o].setAttribute("stroke",existingStrokeData[e].strokeColour):a[o].getAttribute("stroke")&&a[o].setAttribute("stroke","#000000"));!1===i&&(s.setAttribute("stroke-width",1.5),s.setAttribute("stroke","#000000"))}class CreateSVGExpressionData{constructor(){this.retrieveOnlineBARData=new RetrieveOnlineBARData,this.interactiveSVGData=new InteractiveSVGData,this.desiredDOMid="",this.clickList=[],this.svgValues={},this.svgMax=0,this.svgMin=0,this.svgMaxAverage=0,this.svgMaxAverageSample="",this.svgMinAverage=0,this.svgMinAverageSample="",this.svgObjectName=""}addSVGtoDOM(e,t,s=!1,a=!1){var i="Klepikova",o="";""!==e&&(i=e);var r=document.getElementById(this.desiredDOMid);if(r.innerHTML="",s&&this.retrieveOnlineBARData.sampleOptions){o+="Select SVG to display: <select onchange=\"createSVGExpressionData.generateSVG(this.value.toString(), '"+t+"', '"+this.desiredDOMid+"', "+s+", "+a+')" id="sampleOptions" value="'+e+'">';for(var n=this.retrieveOnlineBARData.sampleOptions,l=0;l<n.length;l++)o+='<option value="'+n[l]+'">'+n[l]+"</option>";o+="</select></br>"}var d=!1,f=[];if(a&&this.interactiveSVGData.topExpressionValues){o+="Select top expression to display: <select onchange=\"createSVGExpressionData.generateSVG(this.value.toString(), '"+t+"', '"+this.desiredDOMid+"', "+s+", "+a+')" id="topExpressionOptions">',o+='<option value="hiddenOption" id="hiddenExpressionOption" disabled>Compendiums with maximum average expression:</option>';var g=Object.keys(this.interactiveSVGData.topExpressionValues);for(l=0;l<g.length;l++)if(this.interactiveSVGData.topExpressionValues[g[l]]){var u=this.interactiveSVGData.topExpressionValues[g[l]];if(u.compendium[1]){var h=u.compendium[1];f.push(h);var v=u.sample[1];o+='<option value="'+h+'">'+h+": "+this.retrieveOnlineBARData.sampleData[h].description[v]+" at "+u.maxAverage[1]+"("+g[l]+")</option>"}}o+="</select></br>",f.includes(e)&&(d=!0)}o+="<b>"+e+"</b></br>",o+='<object id="'+i+'_object" data="'+("https://bar.utoronto.ca/~asullivan/ePlant_Plant_eFP/compendiums/"+i+".min.svg")+'" type="image/svg+xml"></object>',r.innerHTML=o,document.getElementById("sampleOptions").selectedIndex=n.indexOf(e),!0===d?(document.getElementById("hiddenExpressionOption").setAttribute("hidden",!0),document.getElementById("topExpressionOptions").selectedIndex=f.indexOf(e)+1):document.getElementById("topExpressionOptions").selectedIndex=0,this.svgObjectName=i+"_object";for(var p=!1;!1===p;)if(""!==r.innerHTML){p=!0,document.getElementById(i+"_object").style="width: 100%; height: 100%; left: 0px; top: 0px; display: inline-block;";setTimeout(()=>{this.createLocusMatch(i,t)},200)}}createLocusMatch(e,t){for(var s=t,a="",i=0;i<s.length;i++)a+=1===i||3===i?s[i].toLowerCase():s[i];this.createSVGValues(e,t)}createSVGValues(e,t){let s=[],a=this.retrieveOnlineBARData.eFPObjects[e].sample,i=Object.keys(a);for(var o=0;o<i.length;o++)s.push(a[i[o]]);for(var r=0;r<i.length;r++){var n=Object.keys(a[i[r]]);void 0===this.svgValues[i[r]]&&(this.svgValues[i[r]]={});for(var l=0;l<n.length;l++)void 0===this.svgValues[i[r]].rawValues&&(this.svgValues[i[r]].rawValues=[]),this.svgValues[i[r]].rawValues.push(a[i[r]][n[l]][t])}this.findExpressionValues(e,i)}standardDeviationCalc(e){var t=0,s=e.length;if(s>=1){for(var a=0,i=0,o=0;o<s;o++)i+=e[o];for(var r=i/s,n=0;n<s;n++)a+=Math.pow(e[n]-r,2);t=Math.sqrt(a/s)}return t}findExpressionValues(e,t){this.svgMax=void 0,this.svgMin=void 0;for(var s=0;s<t.length;s++){for(var a=this.svgValues[t[s]].rawValues.sort(),i=[],o=0;o<a.length;o++)!1===isNaN(a[o])&&i.push(parseFloat(a[o]));for(var r=0,n=0;n<i.length;n++)r+=i[n];var l=r/i.length,d=i[i.length-1],f=i[1];void 0===this.svgMax?this.svgMax=d:d>this.svgMax&&(this.svgMax=d),void 0===this.svgMin?this.svgMin=f:f<this.svgMin&&(this.svgMin=f),void 0===this.svgMaxAverage?(this.svgMaxAverage=l,this.svgMaxAverageSample=t[s]):l>this.svgMaxAverage&&(this.svgMaxAverage=l,this.svgMaxAverageSample=t[s]),void 0===this.svgMinAverage?(this.svgMinAverage=l,this.svgMinAverageSample=t[s]):l<this.svgMinAverage&&(this.svgMinAverage=l,this.svgMinAverageSample=t[s]),void 0===this.svgValues[t[s]]&&(this.svgValues[t[s]]={}),this.svgValues[t[s]].average=l,this.svgValues[t[s]].sd=this.standardDeviationCalc(i);var g=this.retrieveOnlineBARData.sampleData[e],u=Object.keys(g.controlComparison);if(!1===u.includes(t[s])){for(var h="",v=0;v<u.length;v++)g.controlComparison[u[v]].includes(t[s])&&(h=u[v]);if(this.svgValues[h]&&this.svgValues[h].rawValues){for(var p=this.svgValues[h].rawValues,c=0,m=0;m<p.length;m++)c+=parseFloat(p[m]);var x=c/p.length,D=0,b=0;if(null!==x&&x>0&&l>0){l>x?(D=l-x,this.svgValues[t[s]].inductionValue=D):x>l&&(b=x-l,this.svgValues[t[s]].reductionValue=b);var S=l/x;this.svgValues[t[s]].expressionRatio=S,this.svgValues[t[s]].controlSampleName=h,this.svgValues[t[s]].controlAverage=x}}}}this.colourSVGs(e,t)}colourSVGs(e,t){for(var s=0;s<t.length;s++){var a=this.svgMaxAverage-this.svgMinAverage,i=this.svgValues[t[s]].average-this.svgMinAverage;i<0&&(i=0);var o=i/a*100;o>100?o=100:(o<0||null==o)&&(o=0);var r=parseFloat(i+this.svgMinAverage).toFixed(3),n=this.svgValues[t[s]].rawValues.length;this.svgValues[t[s]].expressionLevel=r,this.svgValues[t[s]].sampleSize=n;var l=this.percentageToColour(o);this.colourSVGSubunit(e,t[s],l,r,n)}}colourSVGSubunit(e,t,s,a,i=1){let o=document.getElementById(e+"_object").getSVGDocument();if(o&&o.getElementById(t)){var r=createSVGExpressionData.svgValues[t],n=void 0;this.retrieveOnlineBARData.sampleData[e].description&&(n=this.retrieveOnlineBARData.sampleData[e].description[t]),void 0!==n&&""!==n||(n=t);var l,d=["Control_Shoot_0_Hour","Cold_Shoot_0_Hour","Osmotic_Shoot_0_Hour","Salt_Shoot_0_Hour","Drought_Shoot_0_Hour","Genotoxic_Shoot_0_Hour","Oxidative_Shoot_0_Hour","UV-B_Shoot_0_Hour","Wounding_Shoot_0_Hour","Heat_Shoot_0_Hour"],f=["Control_Root_0_Hour","Cold_Root_0_Hour","Osmotic_Root_0_Hour","Salt_Root_0_Hour","Drought_Root_0_Hour","Genotoxic_Root_0_Hour","Oxidative_Root_0_Hour","UV-B_Root_0_Hour","Wounding_Root_0_Hour","Heat_Root_0_Hour"],g=!1,u=!1;if(d.includes(t)?g=!0:f.includes(t)&&(u=!0),o.getElementById(t)&&o.getElementById(t).childNodes?l=o.getElementById(t).childNodes:setTimeout(function(){o.getElementById(t)&&o.getElementById(t).childNodes&&(l=o.getElementById(t).childNodes)},500),l&&l.length>0)for(var h=0;h<l.length;h++)"path"!==l[h].nodeName&&"g"!==l[h].nodeName||l[h].setAttribute("fill",s);else o&&o.getElementById(t)&&o.getElementById(t).setAttribute("fill",s);o.getElementById(t).setAttribute("class","hoverDetails"),o.getElementById(t).addEventListener("mouseenter",function(e){addTissueMetadata(this.id)}),o.getElementById(t).addEventListener("mouseleave",function(e){removeTissueMetadata(this.id)}),o.getElementById(t).setAttribute("data-expressionValue",a),o.getElementById(t).setAttribute("data-sampleSize",i),o.getElementById(t).setAttribute("data-standardDeviation",r.sd),o.getElementById(t).setAttribute("data-sampleSize",i);var v=document.createElementNS("http://www.w3.org/2000/svg","title");v.textContent=n+"\nExpression level: "+a+"\nSample size: "+i+"\nStandardDeviation: "+parseFloat(r.sd).toFixed(3);var p=!1;if(r.inductionValue?(o.getElementById(t).setAttribute("data-inductionValue",r.inductionValue),v.textContent+="\nInduction Value: "+parseFloat(r.inductionValue).toFixed(3),p=!0):r.reductionValue&&(o.getElementById(t).setAttribute("data-reductionValue",r.reductionValue),v.textContent+="\nReduction Value: "+parseFloat(r.ReductionValue).toFixed(3),p=!0),!0===p){o.getElementById(t).setAttribute("data-expressionRatio",r.expressionRatio),v.textContent+="\nExpression Ratio: "+parseFloat(r.expressionRatio).toFixed(3),o.getElementById(t).setAttribute("data-controlSampleName",r.controlSampleName);var c=void 0;this.retrieveOnlineBARData.sampleData[e].description&&(c=this.retrieveOnlineBARData.sampleData[e].description[r.controlSampleName]),void 0!==c&&""!==c||(c=r.controlSampleName),v.textContent+="\nControl Sample Name: "+c,o.getElementById(t).setAttribute("data-controlAverage",r.controlAverage),v.textContent+="\nControl Expression: "+parseFloat(r.controlAverage).toFixed(3)}if(o.getElementById(t).appendChild(v),g){for(var m=0;m<d.length;m++)if(o.getElementById(d[m])){if(o.getElementById(d[m]).setAttribute("class","hoverDetails"),o.getElementById(d[m]).addEventListener("mouseenter",function(e){addTissueMetadata(this.id)}),o.getElementById(d[m]).addEventListener("mouseleave",function(e){removeTissueMetadata(this.id)}),(l=o.getElementById(d[m]).childNodes).length>0)for(h=0;h<l.length;h++)"path"===l[h].nodeName&&l[h].setAttribute("fill",s);else o.getElementById(d[m]).setAttribute("fill",s);v.textContent=d[m]+"\nExpression level: "+a+"\nSample size: "+i,o.getElementById(d[m]).appendChild(v)}}else if(u)for(var x=0;x<f.length;x++){if(o.getElementById(f[x]).setAttribute("class","hoverDetails"),o.getElementById(f[x]).addEventListener("mouseenter",function(e){addTissueMetadata(this.id)}),o.getElementById(f[x]).addEventListener("mouseleave",function(e){removeTissueMetadata(this.id)}),(l=o.getElementById(f[x]).childNodes).length>0)for(h=0;h<l.length;h++)"path"===l[h].nodeName&&l[h].setAttribute("fill",s);else o.getElementById(f[x]).setAttribute("fill",s);v.textContent=f[x]+"\nExpression level: "+a+"\nSample size: "+i,o.getElementById(f[x]).appendChild(v)}}}percentageToColour(e){return["#ffff00","#fffd00","#fffc00","#fff900","#fff800","#fff600","#fff500","#fff300","#fff200","#fff000","#ffee00","#ffec00","#ffeb00","#ffe800","#ffe700","#ffe600","#ffe300","#ffe100","#ffe000","#ffdf00","#ffdd00","#ffdb00","#ffda00","#ffd800","#ffd600","#ffd300","#ffd200","#ffd000","#ffcf00","#ffcc00","#ffcb00","#ffc900","#ffc700","#ffc500","#ffc300","#ffc300","#ffc000","#ffbf00","#ffbd00","#ffbb00","#ffb900","#ffb800","#ffb500","#ffb300","#ffb200","#ffb000","#ffad00","#ffac00","#ffa900","#ffa800","#ffa600","#ffa400","#ffa200","#ffa100","#ff9e00","#ff9c00","#ff9a00","#ff9900","#ff9600","#ff9400","#ff9300","#ff9000","#ff8f00","#ff8c00","#ff8900","#ff8700","#ff8600","#ff8300","#ff8200","#ff7f00","#ff7c00","#ff7b00","#ff7800","#ff7600","#ff7300","#ff7100","#ff6e00","#ff6c00","#ff6900","#ff6700","#ff6500","#ff6100","#ff5e00","#ff5c00","#ff5900","#ff5600","#ff5300","#ff5000","#ff4d00","#ff4900","#ff4600","#ff4200","#ff3d00","#ff3a00","#ff3400","#ff3000","#ff2a00","#ff2400","#ff1c00","#ff1100","#ff0000"][parseInt(e)]}generateSVG(e,t,s,a=!1,i=!1){this.svgValues={},this.svgMax=void 0,this.svgMin=void 0,this.svgMaxAverage=void 0,this.svgMaxAverageSample=void 0,this.svgMinAverage=void 0,this.svgMinAverageSample=void 0,this.includeDropdownAll=a,this.includeMaxDropdown=i,!1===this.clickList.includes(e)&&this.clickList.push(e),this.desiredDOMid=s,this.retrieveOnlineBARData.loadSampleData(e,t),i&&this.interactiveSVGData.retrieveTopExpressionValues(t),this.updateChecker(e,t)}updateChecker(e,t,s=0){if(s<200){let a=s+1;setTimeout(()=>{Object.keys(this.retrieveOnlineBARData.eFPObjects).length===this.clickList.length?this.addSVGtoDOM(e,t,this.includeDropdownAll,this.includeMaxDropdown):this.updateChecker(e,t,a)},100)}}}const createSVGExpressionData=new CreateSVGExpressionData;