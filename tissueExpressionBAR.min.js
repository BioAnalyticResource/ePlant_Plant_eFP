class RetrieveOnlineBARData{constructor(){this.eFPObjects={},this.sampleData={},this.sampleOptions=[]}loadSampleData(e,t,s=!0){if(0===Object.keys(this.sampleData).length){let s=new XMLHttpRequest,a="https://raw.githubusercontent.com/BioAnalyticResource/ePlant_Plant_eFP/master/data/SampleData.min.json";s.responseType="json",s.onreadystatechange=(()=>{s.readyState===XMLHttpRequest.DONE&&200===s.status&&(this.sampleData=s.response,this.retrieveSampleData(e,t))}),s.open("GET",a),s.send()}Object.keys(this.sampleData).length>0&&s&&this.retrieveSampleData(e,t)}retrieveSampleData(e,t){".svg"===e.substr(-4)&&(e=e.substr(0,e.length-4));var s=Object.keys(this.sampleData);this.sampleOptions=s;var a="",i=[],r=[];if(s.includes(e)){let d=s.indexOf(e);var o=this.sampleData[s[d]],n=o.sample;if(void 0!==(a=o.db)){r=Object.keys(o.sample),i=[];for(var l=0;l<r.length;l++)i=i.concat(n[r[l]])}void 0===this.eFPObjects[e]&&this.callPlantEFP(a,t,i,e,n)}}callPlantEFP(e,t,s,a,i){let r=new XMLHttpRequest,o="https://bar.utoronto.ca/~asullivan/webservices/plantefp.cgi?";o+="datasource="+e+"&",o+="id="+t+"&",o+="samples=[";for(var n=0;n<s.length;n++){var l=s[n].trim();o+='"'+(l=(l=l.replace(/\+/g,"%2B")).replace(/ /g,"%20"))+'"',n!==s.length-1&&(o+=",")}o+="]",r.responseType="json",r.onreadystatechange=(()=>{if(r.readyState===XMLHttpRequest.DONE&&200===r.status){let u=Object.keys(i);var s=r.response;void 0===this.eFPObjects&&(this.eFPObjects={}),void 0===this.eFPObjects[a]&&(this.eFPObjects[a]={}),void 0===this.eFPObjects[a].sample&&(this.eFPObjects[a].sample={}),void 0===this.eFPObjects[a].sample&&(this.eFPObjects[a].sample={});for(var o=0;o<s.length;o++){var n=s[o].name.trim(),l=s[o].value,d="",f=n;f=(f=(f=n.replace(/%2B/g,"+")).replace(/%20/g," ")).trim();for(var g=0;g<u.length;g++)i[u[g]].includes(f)&&(d=u[g],void 0===this.eFPObjects[a].sample[d]&&(this.eFPObjects[a].sample[d]={}),void 0===this.eFPObjects[a].sample[d][f]&&(this.eFPObjects[a].sample[d][f]={}),this.eFPObjects[a].sample[d][f][t]=l)}this.eFPObjects[a].db=e}}),r.open("GET",o),r.send()}}class InteractiveSVGData{constructor(){this.topExpressionValues={},this.expressionValues={}}retrieveTopExpressionValues(e="AT3G24650"){0!==Object.keys(this.topExpressionValues).length&&void 0!==this.topExpressionValues||(this.retrieveTopMicroarray(e),this.retrieveTopRNASeq(e))}retrieveTopMicroarray(e="AT3G24650"){let t=new XMLHttpRequest;var s={loci:[e.toUpperCase()],method:"Microarray"};s=JSON.stringify(s),t.responseType="json",t.onreadystatechange=(()=>{if(t.readyState===XMLHttpRequest.DONE&&200===t.status){let a=t.response;if(a&&!0===a.wasSuccessful&&a.maxAverage){var s={microarray:{maxAverage:a.maxAverage[e.toUpperCase()]}};a.standardDeviation&&(s.microarray.standardDeviation=a.standardDeviation[e.toUpperCase()]),a.sample&&(s.microarray.sample=a.sample[e.toUpperCase()]),a.compendium&&(s.microarray.compendium=a.compendium[e.toUpperCase()]),this.topExpressionValues=Object.assign(this.topExpressionValues,s)}}}),t.open("POST","https://bar.utoronto.ca/expression_max_api/max_average",!0),t.setRequestHeader("Content-Type","application/json"),t.send(s)}retrieveTopRNASeq(e="AT3G24650"){let t=new XMLHttpRequest;var s={loci:[e.toUpperCase()],method:"RNA-seq"};s=JSON.stringify(s),t.responseType="json",t.onreadystatechange=(()=>{if(t.readyState===XMLHttpRequest.DONE&&200===t.status){let a=t.response;if(a&&!0===a.wasSuccessful&&a.maxAverage){var s={rnaSeq:{maxAverage:a.maxAverage[e.toUpperCase()]}};a.standardDeviation&&(s.rnaSeq.standardDeviation=a.standardDeviation[e.toUpperCase()]),a.sample&&(s.rnaSeq.sample=a.sample[e.toUpperCase()]),a.compendium&&(s.rnaSeq.compendium=a.compendium[e.toUpperCase()]),this.topExpressionValues=Object.assign(this.topExpressionValues,s)}}}),t.open("POST","https://bar.utoronto.ca/expression_max_api/max_average",!0),t.setRequestHeader("Content-Type","application/json"),t.send(s)}}let existingStrokeData={};function addTissueMetadata(e){var t,s,a;e.includes("Half_Leaf_Pseudomonas_syringae")&&(e+="_outline"),document.getElementById(createSVGExpressionData.svgObjectName)&&document.getElementById(createSVGExpressionData.svgObjectName).getSVGDocument()&&(a=(s=(t=document.getElementById(createSVGExpressionData.svgObjectName).getSVGDocument()).getElementById(e)).childNodes);var i=void 0,r=void 0,o=!1;if(t&&a&&a.length>0){var n;if(s.getAttribute("stroke-width")&&(i=s.getAttribute("stroke-width"),o=!0),s.getAttribute("stroke")&&(r=s.getAttribute("stroke"),o=!0),!1===o)for(var l=0;l<a.length;l++)"path"===a[l].nodeName&&(a[l].getAttribute("stroke-width")&&(i=a[l].getAttribute("stroke-width"),o=!0),a[l].getAttribute("stroke")&&(r=a[l].getAttribute("stroke"),o=!0));if(n=e,o&&(null!=i&&0!==existingStrokeData||(i=1),null==r&&(r="none"),void 0===existingStrokeData[e]?(existingStrokeData[e]={},existingStrokeData[e].strokeDataExist=o,existingStrokeData[e].strokeWidth=i,existingStrokeData[e].strokeColour=r,existingStrokeData[e].strokeID=n):(existingStrokeData[e].strokeDataExist=o,existingStrokeData[e].strokeWidth=i,existingStrokeData[e].strokeColour=r,existingStrokeData[e].strokeID=n),t.getElementById(existingStrokeData[e].strokeID))){var d=1.5*i;(d<5||0===d)&&(d=2.25);var f=!1;if(t.getElementById(existingStrokeData[e].strokeID).getAttribute("stroke-width"))t.getElementById(existingStrokeData[e].strokeID).setAttribute("stroke-width",d),t.getElementById(existingStrokeData[e].strokeID).setAttribute("stroke","#000000"),f=!0;else if(t&&a&&a.length>0)for(l=0;l<a.length;l++)"path"===a[l].nodeName&&(a[l].getAttribute("stroke-width")&&(a[l].setAttribute("stroke-width",d),f=!0),a[l].getAttribute("stroke")&&a[l].setAttribute("stroke","#000000"));!1===f&&(t.getElementById(existingStrokeData[e].strokeID).setAttribute("stroke-width",d),t.getElementById(existingStrokeData[e].strokeID).setAttribute("stroke","#000000"))}}}function removeTissueMetadata(e){var t,s,a;e.includes("Half_Leaf_Pseudomonas_syringae")&&(e+="_outline"),document.getElementById(createSVGExpressionData.svgObjectName)&&document.getElementById(createSVGExpressionData.svgObjectName).getSVGDocument()&&(a=(s=(t=document.getElementById(createSVGExpressionData.svgObjectName).getSVGDocument()).getElementById(e)).childNodes);var i=!1;if((!1===i||a.length<=0||null===a)&&(s.getAttribute("stroke-width")&&existingStrokeData[e]&&existingStrokeData[e].strokeWidth&&parseFloat(existingStrokeData[e].strokeWidth)>=0&&(t.getElementById(existingStrokeData[e].strokeID).setAttribute("stroke-width",existingStrokeData[e].strokeWidth),i=!0),s.getAttribute("stroke")&&existingStrokeData[e]&&existingStrokeData[e].strokeColour&&t.getElementById(existingStrokeData[e].strokeID).setAttribute("stroke",existingStrokeData[e].strokeColour)),!1===i&&a.length>0)for(var r=0;r<a.length;r++)"path"===a[r].nodeName&&(a[r].getAttribute("stroke-width")&&existingStrokeData[e].strokeWidth&&parseFloat(existingStrokeData[e].strokeWidth)>=0?(a[r].setAttribute("stroke-width",existingStrokeData[e].strokeWidth),i=!0):a[r].getAttribute("stroke-width")&&(a[r].setAttribute("stroke-width",1.5),i=!0),a[r].getAttribute("stroke")&&existingStrokeData[e].strokeColour?a[r].setAttribute("stroke",existingStrokeData[e].strokeColour):a[r].getAttribute("stroke")&&a[r].setAttribute("stroke","#000000"));!1===i&&(s.setAttribute("stroke-width",1.5),s.setAttribute("stroke","#000000"))}class CreateSVGExpressionData{constructor(){this.retrieveOnlineBARData=new RetrieveOnlineBARData,this.interactiveSVGData=new InteractiveSVGData,this.desiredDOMid="",this.clickList=[],this.svgValues={},this.svgMax=0,this.svgMin=0,this.svgMaxAverage=0,this.svgMaxAverageSample="",this.svgMinAverage=0,this.svgMinAverageSample="",this.svgObjectName=""}addSVGtoDOM(e,t,s=!1,a=!1){var i="Klepikova",r="";""!==e&&(i=e);var o=document.getElementById(this.desiredDOMid);if(o.innerHTML="",s&&this.retrieveOnlineBARData.sampleOptions){r+="Select SVG to display: <select onchange=\"createSVGExpressionData.generateSVG(this.value.toString(), '"+t+"', '"+this.desiredDOMid+"', "+s+", "+a+')" id="sampleOptions" value="'+e+'">';for(var n=this.retrieveOnlineBARData.sampleOptions,l=0;l<n.length;l++)r+='<option value="'+n[l]+'">'+n[l]+"</option>";r+="</select></br>"}if(a&&this.interactiveSVGData.topExpressionValues){r+="Select top expression to display: <select onchange=\"createSVGExpressionData.generateSVG(this.value.toString(), '"+t+"', '"+this.desiredDOMid+"', "+s+", "+a+')" id="topExpressionOptions">';var d=Object.keys(topExpressionValues);for(l=0;l<d.length;l++)d[l].length>3&&"top"!==d[l].substring(0,3).toLowerCase()&&(r+='<option value="'+expressionValues[d[l]].Compendium+'">'+d[l]+": "+expressionValues[d[l]].Compendium+"</option>");r+="</select></br>"}r+="<b>"+e+"</b></br>",r+='<object id="'+i+'_object" data="'+("https://bar.utoronto.ca/~asullivan/ePlant_Plant_eFP/compendiums/"+i+".min.svg")+'" type="image/svg+xml"></object>',o.innerHTML=r,this.svgObjectName=i+"_object";for(var f=!1;!1===f;)if(""!==o.innerHTML){f=!0,document.getElementById(i+"_object").style="width: 100%; height: 100%; left: 0px; top: 0px; display: inline-block;";setTimeout(()=>{this.createLocusMatch(i,t)},200)}}createLocusMatch(e,t){for(var s=t,a="",i=0;i<s.length;i++)a+=1===i||3===i?s[i].toLowerCase():s[i];this.createSVGValues(e,t)}createSVGValues(e,t){let s=[],a=this.retrieveOnlineBARData.eFPObjects[e].sample,i=Object.keys(a);for(var r=0;r<i.length;r++)s.push(a[i[r]]);for(var o=0;o<i.length;o++){var n=Object.keys(a[i[o]]);void 0===this.svgValues[i[o]]&&(this.svgValues[i[o]]={});for(var l=0;l<n.length;l++)void 0===this.svgValues[i[o]].rawValues&&(this.svgValues[i[o]].rawValues=[]),this.svgValues[i[o]].rawValues.push(a[i[o]][n[l]][t])}this.findExpressionValues(e,i)}standardDeviationCalc(e){var t=0,s=e.length;if(s>=1){for(var a=0,i=0,r=0;r<s;r++)i+=e[r];for(var o=i/s,n=0;n<s;n++)a+=Math.pow(e[n]-o,2);t=Math.sqrt(a/s)}return t}findExpressionValues(e,t){this.svgMax=void 0,this.svgMin=void 0;for(var s=0;s<t.length;s++){for(var a=this.svgValues[t[s]].rawValues.sort(),i=[],r=0;r<a.length;r++)!1===isNaN(a[r])&&i.push(parseFloat(a[r]));for(var o=0,n=0;n<i.length;n++)o+=i[n];var l=o/i.length,d=i[i.length-1],f=i[1];void 0===this.svgMax?this.svgMax=d:d>this.svgMax&&(this.svgMax=d),void 0===this.svgMin?this.svgMin=f:f<this.svgMin&&(this.svgMin=f),void 0===this.svgMaxAverage?(this.svgMaxAverage=l,this.svgMaxAverageSample=t[s]):l>this.svgMaxAverage&&(this.svgMaxAverage=l,this.svgMaxAverageSample=t[s]),void 0===this.svgMinAverage?(this.svgMinAverage=l,this.svgMinAverageSample=t[s]):l<this.svgMinAverage&&(this.svgMinAverage=l,this.svgMinAverageSample=t[s]),void 0===this.svgValues[t[s]]&&(this.svgValues[t[s]]={}),this.svgValues[t[s]].average=l,this.svgValues[t[s]].sd=this.standardDeviationCalc(i);var g=this.retrieveOnlineBARData.sampleData[e],u=Object.keys(g.controlComparison);if(!1===u.includes(t[s])){for(var h="",v=0;v<u.length;v++)g.controlComparison[u[v]].includes(t[s])&&(h=u[v]);if(this.svgValues[h]&&this.svgValues[h].rawValues){for(var p=this.svgValues[h].rawValues,c=0,m=0;m<p.length;m++)c+=parseFloat(p[m]);var x=c/p.length,S=0,b=0;if(null!==x&&x>0&&l>0){l>x?(S=l-x,this.svgValues[t[s]].inductionValue=S):x>l&&(b=x-l,this.svgValues[t[s]].reductionValue=b);var D=l/x;this.svgValues[t[s]].expressionRatio=D,this.svgValues[t[s]].controlSampleName=h,this.svgValues[t[s]].controlAverage=x}}}}this.colourSVGs(e,t)}colourSVGs(e,t){for(var s=0;s<t.length;s++){var a=this.svgMaxAverage-this.svgMinAverage,i=this.svgValues[t[s]].average-this.svgMinAverage;i<0&&(i=0);var r=i/a*100;r>100?r=100:(r<0||null==r)&&(r=0);var o=parseFloat(i+this.svgMinAverage).toFixed(3),n=this.svgValues[t[s]].rawValues.length;this.svgValues[t[s]].expressionLevel=o,this.svgValues[t[s]].sampleSize=n;var l=this.percentageToColour(r);this.colourSVGSubunit(e,t[s],l,o,n)}}colourSVGSubunit(e,t,s,a,i=1){let r=document.getElementById(e+"_object").getSVGDocument();if(r&&r.getElementById(t)){var o=createSVGExpressionData.svgValues[t],n=void 0;this.retrieveOnlineBARData.sampleData[e].description&&(n=this.retrieveOnlineBARData.sampleData[e].description[t]),void 0!==n&&""!==n||(n=t);var l,d=["Control_Shoot_0_Hour","Cold_Shoot_0_Hour","Osmotic_Shoot_0_Hour","Salt_Shoot_0_Hour","Drought_Shoot_0_Hour","Genotoxic_Shoot_0_Hour","Oxidative_Shoot_0_Hour","UV-B_Shoot_0_Hour","Wounding_Shoot_0_Hour","Heat_Shoot_0_Hour"],f=["Control_Root_0_Hour","Cold_Root_0_Hour","Osmotic_Root_0_Hour","Salt_Root_0_Hour","Drought_Root_0_Hour","Genotoxic_Root_0_Hour","Oxidative_Root_0_Hour","UV-B_Root_0_Hour","Wounding_Root_0_Hour","Heat_Root_0_Hour"],g=!1,u=!1;if(d.includes(t)?g=!0:f.includes(t)&&(u=!0),r.getElementById(t)&&r.getElementById(t).childNodes?l=r.getElementById(t).childNodes:setTimeout(function(){r.getElementById(t)&&r.getElementById(t).childNodes&&(l=r.getElementById(t).childNodes)},500),l&&l.length>0)for(var h=0;h<l.length;h++)"path"!==l[h].nodeName&&"g"!==l[h].nodeName||l[h].setAttribute("fill",s);else r&&r.getElementById(t)&&r.getElementById(t).setAttribute("fill",s);r.getElementById(t).setAttribute("class","hoverDetails"),r.getElementById(t).addEventListener("mouseenter",function(e){addTissueMetadata(this.id)}),r.getElementById(t).addEventListener("mouseleave",function(e){removeTissueMetadata(this.id)}),r.getElementById(t).setAttribute("data-expressionValue",a),r.getElementById(t).setAttribute("data-sampleSize",i),r.getElementById(t).setAttribute("data-standardDeviation",o.sd),r.getElementById(t).setAttribute("data-sampleSize",i);var v=document.createElementNS("http://www.w3.org/2000/svg","title");v.textContent=n+"\nExpression level: "+a+"\nSample size: "+i+"\nStandardDeviation: "+parseFloat(o.sd).toFixed(3);var p=!1;if(o.inductionValue?(r.getElementById(t).setAttribute("data-inductionValue",o.inductionValue),v.textContent+="\nInduction Value: "+parseFloat(o.inductionValue).toFixed(3),p=!0):o.reductionValue&&(r.getElementById(t).setAttribute("data-reductionValue",o.reductionValue),v.textContent+="\nReduction Value: "+parseFloat(o.ReductionValue).toFixed(3),p=!0),!0===p){r.getElementById(t).setAttribute("data-expressionRatio",o.expressionRatio),v.textContent+="\nExpression Ratio: "+parseFloat(o.expressionRatio).toFixed(3),r.getElementById(t).setAttribute("data-controlSampleName",o.controlSampleName);var c=void 0;this.retrieveOnlineBARData.sampleData[e].description&&(c=this.retrieveOnlineBARData.sampleData[e].description[o.controlSampleName]),void 0!==c&&""!==c||(c=o.controlSampleName),v.textContent+="\nControl Sample Name: "+c,r.getElementById(t).setAttribute("data-controlAverage",o.controlAverage),v.textContent+="\nControl Expression: "+parseFloat(o.controlAverage).toFixed(3)}if(r.getElementById(t).appendChild(v),g){for(var m=0;m<d.length;m++)if(r.getElementById(d[m])){if(r.getElementById(d[m]).setAttribute("class","hoverDetails"),r.getElementById(d[m]).addEventListener("mouseenter",function(e){addTissueMetadata(this.id)}),r.getElementById(d[m]).addEventListener("mouseleave",function(e){removeTissueMetadata(this.id)}),(l=r.getElementById(d[m]).childNodes).length>0)for(h=0;h<l.length;h++)"path"===l[h].nodeName&&l[h].setAttribute("fill",s);else r.getElementById(d[m]).setAttribute("fill",s);v.textContent=d[m]+"\nExpression level: "+a+"\nSample size: "+i,r.getElementById(d[m]).appendChild(v)}}else if(u)for(var x=0;x<f.length;x++){if(r.getElementById(f[x]).setAttribute("class","hoverDetails"),r.getElementById(f[x]).addEventListener("mouseenter",function(e){addTissueMetadata(this.id)}),r.getElementById(f[x]).addEventListener("mouseleave",function(e){removeTissueMetadata(this.id)}),(l=r.getElementById(f[x]).childNodes).length>0)for(h=0;h<l.length;h++)"path"===l[h].nodeName&&l[h].setAttribute("fill",s);else r.getElementById(f[x]).setAttribute("fill",s);v.textContent=f[x]+"\nExpression level: "+a+"\nSample size: "+i,r.getElementById(f[x]).appendChild(v)}}}percentageToColour(e){return["#ffff00","#fffd00","#fffc00","#fff900","#fff800","#fff600","#fff500","#fff300","#fff200","#fff000","#ffee00","#ffec00","#ffeb00","#ffe800","#ffe700","#ffe600","#ffe300","#ffe100","#ffe000","#ffdf00","#ffdd00","#ffdb00","#ffda00","#ffd800","#ffd600","#ffd300","#ffd200","#ffd000","#ffcf00","#ffcc00","#ffcb00","#ffc900","#ffc700","#ffc500","#ffc300","#ffc300","#ffc000","#ffbf00","#ffbd00","#ffbb00","#ffb900","#ffb800","#ffb500","#ffb300","#ffb200","#ffb000","#ffad00","#ffac00","#ffa900","#ffa800","#ffa600","#ffa400","#ffa200","#ffa100","#ff9e00","#ff9c00","#ff9a00","#ff9900","#ff9600","#ff9400","#ff9300","#ff9000","#ff8f00","#ff8c00","#ff8900","#ff8700","#ff8600","#ff8300","#ff8200","#ff7f00","#ff7c00","#ff7b00","#ff7800","#ff7600","#ff7300","#ff7100","#ff6e00","#ff6c00","#ff6900","#ff6700","#ff6500","#ff6100","#ff5e00","#ff5c00","#ff5900","#ff5600","#ff5300","#ff5000","#ff4d00","#ff4900","#ff4600","#ff4200","#ff3d00","#ff3a00","#ff3400","#ff3000","#ff2a00","#ff2400","#ff1c00","#ff1100","#ff0000"][parseInt(e)]}generateSVG(e,t,s,a=!1,i=!1){this.svgValues={},this.svgMax=void 0,this.svgMin=void 0,this.svgMaxAverage=void 0,this.svgMaxAverageSample=void 0,this.svgMinAverage=void 0,this.svgMinAverageSample=void 0,this.includeDropdownAll=a,this.includeMaxDropdown=i,!1===this.clickList.includes(e)&&this.clickList.push(e),this.desiredDOMid=s,this.retrieveOnlineBARData.loadSampleData(e,t),i&&this.interactiveSVGData.retrieveTopExpressionValues(t),this.updateChecker(e,t)}updateChecker(e,t,s=0){if(s<200){let a=s+1;setTimeout(()=>{Object.keys(this.retrieveOnlineBARData.eFPObjects).length===this.clickList.length?this.addSVGtoDOM(e,t,this.includeDropdownAll,this.includeMaxDropdown):this.updateChecker(e,t,a)},100)}}}const createSVGExpressionData=new CreateSVGExpressionData;